<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa de Ferramentas do Vendedor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f8fafc; /* Fundo mais suave */
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .result-box {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.25rem;
        }
        /* Estilos do Funil Kanban Moderno */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 6 colunas */
            gap: 1.5rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            min-height: 450px;
        }
        .kanban-column {
            min-width: 280px;
            background-color: #f1f5f9;
            border-radius: 0.75rem; /* Mais arredondado */
            padding: 1rem;
            transition: background-color 0.2s;
        }
        .kanban-column-header {
            padding: 0 0.25rem 1rem 0.25rem;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .kanban-column-header h3 {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .column-indicators {
            font-size: 0.875rem;
            color: #475569;
        }
        .kanban-cards {
            min-height: 250px;
            padding-bottom: 1rem;
            transition: background-color 0.2s;
        }
        .kanban-card {
            position: relative; /* Adicionado para o botão de apagar */
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
            cursor: grab;
            border: 1px solid #e2e8f0;
        }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card.dragging { opacity: 0.5; transform: rotate(2deg); }
        .drag-over { background-color: #e0e7ff !important; }
        
        .card-title-input {
            font-size: 1.1rem; border: none; outline: none;
            padding: 2px; margin: -2px; width: calc(100% + 4px);
        }
        .card-details-input {
            width: 100%; font-size: 0.875rem; border: none;
            outline: none; background-color: transparent; padding: 2px;
        }
        .card-details-input:focus, .card-title-input:focus {
            background-color: #f8fafc;
            box-shadow: 0 0 0 1px #3b82f6;
            border-radius: 0.25rem;
        }
        textarea.card-details-input { resize: vertical; }

        .card-value-input {
            width: 100%; border: none; border-radius: 0.375rem; padding: 0.25rem 0.5rem;
            font-size: 1.125rem; font-weight: 700;
        }
        .indicator-card {
            background-color: white; padding: 1rem; border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07); border: 1px solid #e2e8f0;
        }
        
        /* Estilos para Tooltip */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #94a3b8;
            margin-left: 6px;
        }
        .tooltip-text {
            visibility: hidden; width: 250px; background-color: #1e293b; color: #fff; text-align: left;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
            margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; line-height: 1.4;
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px;
            border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .quem-paga-btn {
            padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; cursor: pointer;
            transition: all 0.2s ease-in-out; font-weight: 500;
        }
        .quem-paga-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .calc-mode-btn {
            flex: 1; padding: 0.5rem; border-radius: 0.5rem; font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .calc-mode-btn.active { background-color: #3b82f6; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::after { content: '+'; float: right; font-size: 1.5rem; font-weight: bold; }
        details[open] > summary::after { content: '−'; }
        
        .task-item.completed span {
            text-decoration: line-through;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Auth Overlay -->
    <div id="authOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <!-- Login Form -->
            <div id="loginForm">
                <h2 class="text-2xl font-bold text-center mb-6">Entrar na Ferramenta</h2>
                <div id="loginError" class="text-red-500 text-sm mb-4 text-center"></div>
                <div class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="loginEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="loginButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Entrar
                    </button>
                </div>
                <p class="mt-4 text-center text-sm">
                    Não tem uma conta? <a href="#" id="showRegister" class="font-medium text-blue-600 hover:text-blue-500">Crie uma aqui</a>
                </p>
            </div>
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                 <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2>
                 <div id="registerError" class="text-red-500 text-sm mb-4 text-center"></div>
                <div class="space-y-4">
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="registerEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="registerPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="registerButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                        Criar Conta
                    </button>
                </div>
                 <p class="mt-4 text-center text-sm">
                    Já tem uma conta? <a href="#" id="showLogin" class="font-medium text-blue-600 hover:text-blue-500">Entre aqui</a>
                </p>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-screen-2xl">
            <header class="flex flex-col md:flex-row justify-between items-center mb-10">
                <div class="text-center md:text-left">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Caixa de Ferramentas do Vendedor</h1>
                    <p class="text-lg text-gray-600 mt-2">Suas ferramentas essenciais para vender mais e melhor.</p>
                </div>
                <div id="userSection" class="hidden mt-4 md:mt-0 text-center md:text-right">
                    <div class="bg-white p-3 rounded-lg shadow-sm border">
                        <p class="text-xs font-medium text-gray-500">Vendedor:</p>
                        <p id="userEmailDisplay" class="text-sm font-semibold text-blue-700"></p>
                        <div id="syncStatus" class="flex items-center justify-center md:justify-end text-xs mt-2"></div>
                        <button id="logoutButton" class="mt-2 text-xs text-red-600 hover:underline">Sair</button>
                    </div>
                </div>
            </header>

            <div class="mb-8 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button onclick="window.changeTab(event, 'lucratividade')" class="tab-button active text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-calculator"></i>Calculadoras</button>
                    <button onclick="window.changeTab(event, 'funil')" class="tab-button text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-funnel"></i>Funil de Vendas</button>
                    <button onclick="window.changeTab(event, 'vendas')" class="tab-button text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-chart-bar"></i>Vendas da Equipe</button>
                    <button onclick="window.changeTab(event, 'plano-acao')" class="tab-button text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-list-checks"></i>Plano de Ação</button>
                    <button onclick="window.changeTab(event, 'concorrencia')" class="tab-button text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-users-three"></i>Concorrência</button>
                    <button onclick="window.changeTab(event, 'estrategias')" class="tab-button text-sm md:text-base font-medium py-4 px-3 border-b-2 border-transparent"><i class="ph-bold ph-strategy"></i>Estratégias e Scripts</button>
                </nav>
            </div>

            <main>
                <!-- Calculadoras -->
                <div id="lucratividade" class="tab-content active">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <!-- Nova Calculadora Financeira -->
                        <div class="bg-white p-6 md:p-8 rounded-lg shadow-md lg:col-span-3">
                            <h2 class="text-2xl font-bold mb-1">Calculadoras Financeiras</h2>
                            <p class="text-gray-600 mb-4">Selecione o modo de cálculo e preencha os campos.</p>
                            
                            <div class="flex items-center justify-center gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                                <button id="btnLucratividade" onclick="window.changeCalcMode('lucratividade')" class="calc-mode-btn active">Lucratividade</button>
                                <button id="btnRoi" onclick="window.changeCalcMode('roi')" class="calc-mode-btn">ROI (Cliente)</button>
                                <button id="btnTco" onclick="window.changeCalcMode('tco')" class="calc-mode-btn">TCO (Custo Total)</button>
                            </div>

                            <!-- MODO PRODUTO ÚNICO / KIT -->
                            <div id="modoLucratividade">
                                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                                    <h4 class="font-bold text-blue-800">Para que serve?</h4>
                                    <p class="text-sm text-blue-700 mt-1">Use esta calculadora para definir o preço de venda de um produto ou proposta (kit) garantindo sua margem de lucro, ou para analisar a lucratividade de um preço já definido. Ideal para o planejamento interno.</p>
                                </div>
                                <div class="flex items-center justify-center gap-2 mb-6 bg-gray-200 p-1 rounded-lg w-full md:w-2/3 mx-auto">
                                    <button id="btnProdutoUnico" onclick="window.changeSubCalcMode('unico')" class="calc-mode-btn active">Produto Único</button>
                                    <button id="btnKit" onclick="window.changeSubCalcMode('kit')" class="calc-mode-btn">Proposta (Kit)</button>
                                </div>
                                <!-- MODO PRODUTO ÚNICO -->
                                <div id="calcModoUnico">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <div class="space-y-4">
                                            <h3 class="font-semibold text-lg border-b pb-2">1. Custos Diretos</h3>
                                            <div><label for="custoProduto" class="block text-sm font-medium text-gray-700 tooltip-container">Custo do Produto (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Valor pago ao fornecedor pela mercadoria que está sendo vendida.</span></label><input type="number" id="custoProduto" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="100.00"></div>
                                            <div><label for="impostosRecuperaveis" class="block text-sm font-medium text-gray-700 tooltip-container">Impostos Recuperáveis na Compra (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Valor total dos impostos (ICMS, PIS/COFINS) que sua empresa credita ao comprar este produto. Este valor reduz o custo efetivo.</span></label><input type="number" id="impostosRecuperaveis" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="12.00"></div>
                                            <div><label for="frete" class="block text-sm font-medium text-gray-700 tooltip-container">Frete (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Custo de transporte para entregar o produto ao cliente, caso seja pago pela sua empresa.</span></label><input type="number" id="frete" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="25.00"></div>
                                        </div>
                                        <div class="space-y-4">
                                            <h3 class="font-semibold text-lg border-b pb-2">2. Despesas da Venda</h3>
                                            <div><label for="impostosVenda" class="block text-sm font-medium text-gray-700 tooltip-container">Impostos Sobre a Venda (%) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Percentual total de impostos que incidem sobre o preço final da venda (Ex: IPI, ICMS, PIS, COFINS de saída).</span></label><input type="number" id="impostosVenda" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="18"></div>
                                            <div><label for="taxaPagamentoUnico" class="block text-sm font-medium text-gray-700 tooltip-container">Taxa Pagamento (à vista) (%) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Percentual da taxa da maquininha de cartão, gateway de pagamento ou boleto para pagamento à vista.</span></label><input type="number" id="taxaPagamentoUnico" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="4.5"></div>
                                            <div><label for="comissaoUnico" class="block text-sm font-medium text-gray-700 tooltip-container">Comissão (%) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Percentual de comissão a ser pago ao vendedor sobre o preço da venda.</span></label><input type="number" id="comissaoUnico" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="5"></div>
                                            <div><label for="custoFixoUnico" class="block text-sm font-medium text-gray-700 tooltip-container">Rateio Custo Fixo (%) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Opcional. Um percentual do preço da venda para ajudar a cobrir custos fixos da empresa (aluguel, salários, etc.).</span></label><input type="number" id="custoFixoUnico" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="3"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- MODO PROPOSTA (KIT) -->
                                <div id="calcModoKit" class="hidden">
                                    <h3 class="font-semibold text-lg border-b pb-2">1. Itens da Proposta</h3>
                                    <div id="itensKitContainer" class="space-y-3 mt-4 max-h-60 overflow-y-auto pr-2">
                                        <!-- Itens adicionados dinamicamente aqui -->
                                    </div>
                                    <div class="grid grid-cols-12 gap-2 mt-4 p-2 bg-gray-50 rounded-md items-end">
                                        <div class="col-span-12 md:col-span-4"><label class="text-xs font-medium">Nome do Item</label><input type="text" id="kitItemNome" placeholder="Ex: Produto A" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md"></div>
                                        <div class="col-span-4 md:col-span-2"><label class="text-xs font-medium">Custo (R$)</label><input type="number" id="kitItemCusto" placeholder="50.00" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md"></div>
                                        <div class="col-span-2 md:col-span-1"><label class="text-xs font-medium">Qtd.</label><input type="number" id="kitItemQtd" value="1" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md"></div>
                                        <div class="col-span-3 md:col-span-2"><label class="text-xs font-medium">IPI (%)</label><input type="number" id="kitItemIPI" placeholder="10" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md"></div>
                                        <div class="col-span-3 md:col-span-2"><label class="text-xs font-medium">ICMS ST (%)</label><input type="number" id="kitItemICMS" placeholder="18" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md"></div>
                                        <button onclick="window.adicionarItemKit()" class="col-span-12 md:col-span-1 bg-blue-500 text-white rounded-md h-9 w-full flex-shrink-0 hover:bg-blue-600 flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
                                    </div>
                                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-right">
                                        <span class="text-sm font-medium text-gray-600">Custo Total Direto da Proposta:</span>
                                        <span id="custoTotalKit" class="text-lg font-bold text-blue-700 ml-2">R$ 0,00</span>
                                    </div>
                                    <div class="mt-4">
                                        <h3 class="font-semibold text-lg border-b pb-2">2. Despesas da Proposta</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mt-4">
                                            <div class="space-y-4 md:col-start-2">
                                                <div><label for="taxaPagamentoKit" class="block text-sm font-medium text-gray-700">Taxa Pagamento (à vista) (%)</label><input type="number" id="taxaPagamentoKit" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="4.5"></div>
                                                <div><label for="comissaoKit" class="block text-sm font-medium text-gray-700">Comissão (%)</label><input type="number" id="comissaoKit" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="5"></div>
                                                <div><label for="custoFixoKit" class="block text-sm font-medium text-gray-700">Rateio Custo Fixo (%)</label><input type="number" id="custoFixoKit" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- SEÇÃO DE PREÇO E LUCRO (COMUM A AMBOS) -->
                                <div class="mt-6 pt-6 border-t">
                                    <h3 class="font-semibold text-lg pb-2">3. Preço e Lucro</h3>
                                    <p class="text-sm text-gray-500 mb-4">Preencha <span class="font-bold">um</span> dos campos abaixo e clique no botão correspondente.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                        <div>
                                            <label for="precoVenda" class="block text-sm font-medium text-gray-700">Preço de Venda Final (R$)</label>
                                            <input type="number" id="precoVenda" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="250.00">
                                            <button onclick="window.analiseFinanceira('analisar')" class="mt-2 w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-700 transition">Analisar Venda</button>
                                        </div>
                                        <div>
                                            <label for="margemLucro" class="block text-sm font-medium text-gray-700">Margem de Lucro Desejada (%)</label>
                                            <input type="number" id="margemLucro" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="20">
                                            <button onclick="window.analiseFinanceira('precificar')" class="mt-2 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Calcular Preço</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MODO ROI -->
                            <div id="calcModoRoi" class="hidden">
                                <div class="bg-teal-50 border-l-4 border-teal-500 p-4 mb-6 rounded-r-lg">
                                    <h4 class="font-bold text-teal-800">Para que serve?</h4>
                                    <p class="text-sm text-teal-700 mt-1">Use esta ferramenta para mostrar ao cliente que seu produto não é um custo, mas um investimento. Calcule em quanto tempo ele recupera o valor pago e qual será o retorno financeiro, transformando a conversa de preço em uma conversa de valor.</p>
                                </div>
                                <h3 class="font-semibold text-xl border-b pb-2 mb-4">Calculadora de ROI para o Cliente</h3>
                                <div class="space-y-4">
                                    <div class="relative">
                                        <label for="roiInvestimento" class="block text-sm font-medium text-gray-700 tooltip-container">Investimento Total (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">O preço final da sua solução para o cliente.</span></label>
                                        <input type="number" id="roiInvestimento" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="5000.00">
                                        <button onclick="window.usarUltimoPreco()" class="absolute right-2 top-7 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Usar último preço</button>
                                    </div>
                                    <div><label for="roiGanhos" class="block text-sm font-medium text-gray-700 tooltip-container">Ganhos Mensais p/ Cliente (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Quanto o cliente vai economizar ou faturar a mais por mês com sua solução.</span></label><input type="number" id="roiGanhos" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="800.00"></div>
                                    <div><label for="roiCustoMensal" class="block text-sm font-medium text-gray-700 tooltip-container">Custo Mensal da Solução (R$) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Se houver uma mensalidade ou custo de manutenção, informe aqui. Deixe 0 se não houver.</span></label><input type="number" id="roiCustoMensal" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="0"></div>
                                    <div><label for="roiPeriodo" class="block text-sm font-medium text-gray-700 tooltip-container">Período de Análise (meses) <i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Informe em quantos meses você deseja calcular o retorno para o cliente. Comum usar 12, 24 ou 36 meses.</span></label><input type="number" id="roiPeriodo" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" value="12" placeholder="12"></div>
                                </div>
                                <button onclick="window.calcularRoi()" class="mt-6 w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-md hover:bg-teal-700 transition">Calcular ROI</button>
                            </div>

                            <!-- MODO TCO -->
                            <div id="calcModoTco" class="hidden">
                                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-6 rounded-r-lg">
                                    <h4 class="font-bold text-purple-800">Para que serve?</h4>
                                    <p class="text-sm text-purple-700 mt-1">Use esta calculadora para provar que sua solução, mesmo que tenha um preço inicial maior, é mais econômica a longo prazo. Compare-a com uma alternativa mais barata e mostre a economia real que o cliente terá com o Custo Total de Propriedade.</p>
                                </div>
                                <h3 class="font-semibold text-xl border-b pb-2 mb-4">Calculadora de Custo Total de Propriedade (TCO)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Sua Solução -->
                                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <h4 class="font-bold text-lg text-blue-800">Sua Solução</h4>
                                        <div class="space-y-3 mt-2">
                                            <div>
                                                <label for="tcoPrecoA" class="text-sm font-medium tooltip-container">Preço de Compra (R$)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">O valor pago para adquirir a solução. Geralmente, o preço da sua proposta.</span></label>
                                                <input id="tcoPrecoA" type="text" placeholder="R$ 10.000,00" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" oninput="window.formatInputCurrency(this)">
                                            </div>
                                            <div>
                                                <label for="tcoManutencaoA" class="text-sm font-medium tooltip-container">Custo Anual (manutenção, etc)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Soma de todos os custos recorrentes anuais, como mensalidades, suporte, peças, etc.</span></label>
                                                <input id="tcoManutencaoA" type="text" placeholder="R$ 200,00" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" oninput="window.formatInputCurrency(this)">
                                            </div>
                                            <div>
                                                <label for="tcoVidaUtilA" class="text-sm font-medium tooltip-container">Vida Útil (Anos)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">O tempo estimado, em anos, que a solução funcionará antes de precisar ser substituída.</span></label>
                                                <input id="tcoVidaUtilA" type="number" placeholder="5" value="5" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Concorrente -->
                                    <div class="bg-gray-100 p-4 rounded-lg border">
                                        <h4 class="font-bold text-lg text-gray-800">Concorrente / Alternativa</h4>
                                        <div class="space-y-3 mt-2">
                                            <div>
                                                <label for="tcoPrecoB" class="text-sm font-medium tooltip-container">Preço de Compra (R$)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">O valor pago para adquirir a solução concorrente ou alternativa.</span></label>
                                                <input id="tcoPrecoB" type="text" placeholder="R$ 7.000,00" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" oninput="window.formatInputCurrency(this)">
                                            </div>
                                            <div>
                                                <label for="tcoManutencaoB" class="text-sm font-medium tooltip-container">Custo Anual (manutenção, etc)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">Soma de todos os custos recorrentes anuais da solução concorrente.</span></label>
                                                <input id="tcoManutencaoB" type="text" placeholder="R$ 800,00" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" oninput="window.formatInputCurrency(this)">
                                            </div>
                                            <div>
                                                <label for="tcoVidaUtilB" class="text-sm font-medium tooltip-container">Vida Útil (Anos)<i class="ph ph-question tooltip-icon"></i><span class="tooltip-text">O tempo estimado, em anos, que a solução concorrente funcionará antes de precisar ser substituída.</span></label>
                                                <input id="tcoVidaUtilB" type="number" placeholder="3" value="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="window.calcularTco()" class="mt-6 w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition">Calcular Custo Total</button>
                            </div>
                        </div>
                        <!-- Coluna de Resultados -->
                        <div class="bg-white p-6 md:p-8 rounded-lg shadow-md lg:col-span-2">
                            <h2 class="text-2xl font-bold mb-1">Resultados</h2>
                            <div id="resultadoAnalise" class="result-box mt-6">
                                <p class="text-gray-500 text-center py-10">Preencha os campos e calcule para ver os resultados.</p>
                            </div>
                            <!-- Simulador de Negociação -->
                            <div id="simuladorNegociacao" class="mt-6 hidden">
                                <h2 class="text-2xl font-bold mb-1 border-t pt-6">Simulador de Negociação</h2>
                                <p class="text-gray-600 mb-6">Teste cenários para tomar as melhores decisões.</p>

                                <div class="space-y-6">
                                    <!-- Simular Desconto -->
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-lg">1. Qual o impacto de um desconto?</h3>
                                        <div class="flex items-end gap-2 mt-2">
                                            <div class="flex-grow">
                                                <label for="simularDescontoInput" class="text-sm font-medium">Desconto (%)</label>
                                                <input type="number" id="simularDescontoInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="10">
                                            </div>
                                            <button onclick="window.simularDesconto()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition h-11">Simular</button>
                                        </div>
                                        <div id="resultadoSimularDesconto" class="mt-3"></div>
                                    </div>

                                    <!-- Calcular Desconto Máximo -->
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-lg">2. Qual o desconto máximo que posso dar?</h3>
                                        <div class="flex items-end gap-2 mt-2">
                                            <div class="flex-grow">
                                                <label for="descontoMaximoInput" class="text-sm font-medium">Mantendo a margem mínima de (%)</label>
                                                <input type="number" id="descontoMaximoInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="15">
                                            </div>
                                            <button onclick="window.calcularDescontoMaximo()" class="bg-rose-600 text-white font-bold py-2 px-4 rounded-md hover:bg-rose-700 transition h-11">Calcular</button>
                                        </div>
                                        <div id="resultadoDescontoMaximo" class="mt-3"></div>
                                    </div>
                                    
                                    <!-- Simular Parcelamento -->
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-lg">3. Como fica o lucro se eu parcelar?</h3>
                                        <div class="mt-3">
                                            <label class="text-sm font-medium text-gray-700">Quem assume a taxa?</label>
                                            <div class="flex gap-2 mt-1" id="quemPagaTaxaContainer">
                                                <button type="button" data-value="empresa" class="quem-paga-btn active flex-1">Fornecedor</button>
                                                <button type="button" data-value="cliente" class="quem-paga-btn flex-1">Cliente</button>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mt-3">
                                            <div class="flex-grow">
                                                <label for="numParcelasInput" class="text-sm font-medium">Nº de Parcelas</label>
                                                <input type="number" id="numParcelasInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="3">
                                            </div>
                                            <div class="flex-grow">
                                                <label for="taxaParcelamentoInput" class="text-sm font-medium">Taxa da Operadora (%)</label>
                                                <input type="number" id="taxaParcelamentoInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="8.5">
                                            </div>
                                        </div>
                                        <button onclick="window.calcularParcelamento()" class="w-full mt-3 bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition">Calcular Parcelamento</button>
                                        <div id="resultadoParcelamento" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funil de Vendas -->
                <div id="funil" class="tab-content">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold mb-2">Funil de Vendas Pessoal</h2>
                        <p class="text-gray-600 mb-6">Arraste os negócios entre as fases para atualizar seu pipeline. Seus dados são salvos automaticamente.</p>
                        
                        <div class="bg-white p-4 rounded-lg shadow-md border mb-8">
                            <label for="metaInput" class="block text-sm font-medium text-gray-700">Defina sua Meta de Vendas (R$)</label>
                            <input type="text" id="metaInput" class="mt-1 w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 50000" oninput="window.formatInputCurrency(this); window.debounceSaveGoal();">
                            <div class="mt-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-base font-medium text-blue-700">Progresso da Meta</span>
                                    <span id="goalPercentage" class="text-sm font-medium text-blue-700">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="goalProgressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
                                </div>
                                <p id="goalRemaining" class="text-sm text-gray-600 text-right mt-2"></p>
                            </div>
                        </div>


                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-blue-100 text-blue-600 p-3 rounded-lg"><i class="ph-bold ph-chart-line-up text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Valor em Aberto</p><p id="active-value" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                            </div>
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg"><i class="ph-bold ph-scales text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Forecast Ponderado</p><p id="weighted-value" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                            </div>
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-amber-100 text-amber-600 p-3 rounded-lg"><i class="ph-bold ph-tag text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Ticket Médio (Ganho)</p><p id="average-ticket" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                            </div>
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-emerald-100 text-emerald-600 p-3 rounded-lg"><i class="ph-bold ph-trophy text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Total Ganho</p><p id="won-value" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                            </div>
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-slate-100 text-slate-600 p-3 rounded-lg"><i class="ph-bold ph-thumbs-down text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Total Perdido</p><p id="lost-value" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                            </div>
                            <div class="indicator-card flex items-start gap-4 p-5">
                                <div class="bg-rose-100 text-rose-600 p-3 rounded-lg"><i class="ph-bold ph-arrows-clockwise text-2xl"></i></div>
                                <div><p class="text-sm text-gray-500">Taxa de Conversão</p><p id="conversion-rate" class="text-2xl font-bold text-gray-800">0%</p></div>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mb-6 border-b pb-6">
                            <input type="text" id="newCardInput" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Nome do novo lead/negócio">
                            <button onclick="window.addCard()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"><i class="ph-bold ph-plus-circle"></i> Adicionar</button>
                        </div>
                        <div class="kanban-board">
                            <div class="kanban-column" data-column="prospect"><div class="kanban-column-header"><h3><i class="ph-fill ph-binoculars text-sky-500"></i> Prospectando</h3><div class="column-indicators" id="indicators-prospect"></div></div><div class="kanban-cards"></div></div>
                            <div class="kanban-column" data-column="qualify"><div class="kanban-column-header"><h3><i class="ph-fill ph-lightbulb text-amber-500"></i> Qualificação</h3><div class="column-indicators" id="indicators-qualify"></div></div><div class="kanban-cards"></div></div>
                            <div class="kanban-column" data-column="proposal"><div class="kanban-column-header"><h3><i class="ph-fill ph-file-text text-indigo-500"></i> Proposta</h3><div class="column-indicators" id="indicators-proposal"></div></div><div class="kanban-cards"></div></div>
                            <div class="kanban-column" data-column="negotiate"><div class="kanban-column-header"><h3><i class="ph-fill ph-handshake text-rose-500"></i> Negociação</h3><div class="column-indicators" id="indicators-negotiate"></div></div><div class="kanban-cards"></div></div>
                            <div class="kanban-column" data-column="won"><div class="kanban-column-header"><h3><i class="ph-fill ph-trophy text-emerald-500"></i> Ganho</h3><div class="column-indicators" id="indicators-won"></div></div><div class="kanban-cards"></div></div>
                            <div class="kanban-column" data-column="lost"><div class="kanban-column-header"><h3><i class="ph-fill ph-x-circle text-slate-500"></i> Perdido</h3><div class="column-indicators" id="indicators-lost"></div></div><div class="kanban-cards"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Vendas da Equipe -->
                <div id="vendas" class="tab-content">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg space-y-8">
                        <!-- Meta da Equipe -->
                        <div>
                            <h2 class="text-3xl font-bold mb-2">Desempenho da Equipe</h2>
                            <p class="text-gray-600 mb-6">Acompanhe a meta de vendas geral e os últimos negócios fechados por toda a equipe.</p>
                            <div class="bg-white p-4 rounded-lg shadow-md border">
                                <label for="teamMetaInput" class="block text-sm font-medium text-gray-700">Defina a Meta Geral da Equipe (R$)</label>
                                <input type="text" id="teamMetaInput" class="mt-1 w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 250000" oninput="window.formatInputCurrency(this); window.debounceSaveTeamGoal();">
                                <div class="mt-4">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-base font-medium text-blue-700">Progresso da Meta da Equipe</span>
                                        <span id="teamGoalPercentage" class="text-sm font-medium text-blue-700">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="teamGoalProgressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p id="teamGoalRemaining" class="text-sm text-gray-600 text-right mt-2"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Vendas Ganhas -->
                        <div>
                            <h2 class="text-3xl font-bold mb-2">Últimas Vendas Ganhas</h2>
                             <div class="mt-4 overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Negócio</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wonDealsList" class="divide-y divide-gray-200">
                                        <!-- Linhas serão inseridas dinamicamente aqui -->
                                        <tr><td colspan="4" class="p-6 text-center text-gray-500">Nenhuma venda ganha ainda.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Plano de Ação -->
                <div id="plano-acao" class="tab-content">
                     <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                         <h2 class="text-3xl font-bold mb-2">Plano de Ação e Tarefas</h2>
                         <p class="text-gray-600 mb-6">Organize suas atividades e próximos passos. Suas tarefas são salvas automaticamente.</p>
                         <div class="flex flex-col md:flex-row gap-4 mb-6 border-b pb-6">
                             <input type="text" id="newTaskInput" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Adicionar nova tarefa (Ex: Ligar para o cliente X)">
                             <button onclick="window.addTask()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"><i class="ph-bold ph-plus-circle"></i> Adicionar Tarefa</button>
                         </div>
                         <div id="taskListContainer" class="space-y-3">
                             <!-- Tarefas serão inseridas aqui -->
                         </div>
                    </div>
                </div>

                <!-- Análise de Concorrência -->
                <div id="concorrencia" class="tab-content">
                    <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-1">Análise de Concorrência</h2>
                        <p class="text-gray-600 mb-6">Anote os pontos fortes e fracos dos seus principais concorrentes. Suas notas são salvas automaticamente.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg"><input type="text" id="concorrente1_nome" placeholder="Nome do Concorrente 1" class="w-full font-bold text-lg mb-2 bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-blue-500" oninput="window.debounceSaveNotes()"><label class="font-semibold mt-4 block">Pontos Fortes:</label><textarea id="concorrente1_fortes" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" placeholder="Ex: Preço agressivo..." oninput="window.debounceSaveNotes()"></textarea><label class="font-semibold mt-4 block">Pontos Fracos:</label><textarea id="concorrente1_fracos" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" placeholder="Ex: Suporte ao cliente..." oninput="window.debounceSaveNotes()"></textarea></div>
                            <div class="bg-gray-50 p-4 rounded-lg"><input type="text" id="concorrente2_nome" placeholder="Nome do Concorrente 2" class="w-full font-bold text-lg mb-2 bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-blue-500" oninput="window.debounceSaveNotes()"><label class="font-semibold mt-4 block">Pontos Fortes:</label><textarea id="concorrente2_fortes" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" oninput="window.debounceSaveNotes()"></textarea><label class="font-semibold mt-4 block">Pontos Fracos:</label><textarea id="concorrente2_fracos" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" oninput="window.debounceSaveNotes()"></textarea></div>
                            <div class="bg-gray-50 p-4 rounded-lg"><input type="text" id="concorrente3_nome" placeholder="Nome do Concorrente 3" class="w-full font-bold text-lg mb-2 bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-blue-500" oninput="window.debounceSaveNotes()"><label class="font-semibold mt-4 block">Pontos Fortes:</label><textarea id="concorrente3_fortes" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" oninput="window.debounceSaveNotes()"></textarea><label class="font-semibold mt-4 block">Pontos Fracos:</label><textarea id="concorrente3_fracos" class="w-full mt-1 p-2 border border-gray-200 rounded-md h-32" oninput="window.debounceSaveNotes()"></textarea></div>
                        </div>
                    </div>
                </div>

                <!-- Estratégias de Vendas -->
                <div id="estrategias" class="tab-content">
                    <div class="bg-white p-6 md:p-8 rounded-lg shadow-md space-y-10">
                        <div class="bg-white p-6 rounded-lg shadow-md border">
                            <h2 class="text-2xl font-bold mb-1">Gerador de Abordagem Personalizada</h2>
                            <p class="text-gray-600 mb-6">Preencha os dados para gerar um plano de ação e script de abordagem para o seu cliente.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="abordagemNomeCliente" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label><input type="text" id="abordagemNomeCliente" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: João Silva"></div>
                                <div><label for="abordagemNomeEmpresa" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label><input type="text" id="abordagemNomeEmpresa" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: Silva & Filhos Ltda"></div>
                                <div><label for="abordagemProduto" class="block text-sm font-medium text-gray-700 mb-1">Seu Produto/Serviço</label><input type="text" id="abordagemProduto" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: Software de Gestão"></div>
                                <div><label for="abordagemDor" class="block text-sm font-medium text-gray-700 mb-1">Principal Dor que resolve</label><input type="text" id="abordagemDor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: Otimizar o controle de estoque"></div>
                                <div class="md:col-span-2">
                                    <label for="abordagemPerfil" class="block text-sm font-medium text-gray-700 mb-1">Perfil Comportamental do Cliente</label>
                                    <select id="abordagemPerfil" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="lobo">Lobo (Analítico)</option>
                                        <option value="gato">Gato (Relacional)</option>
                                        <option value="tubarao">Tubarão (Executor)</option>
                                        <option value="aguia">Águia (Visionário)</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="window.gerarPlanoAcao()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition">Gerar Plano de Ação</button>
                            <div id="resultadoPlanoAcao" class="result-box mt-6 hidden"></div>
                        </div>

                        <div>
                            <h2 class="text-3xl font-bold mb-2">Decifrando Perfis de Cliente</h2>
                            <p class="text-gray-600 mb-6">Adapte sua abordagem ao estilo de cada cliente para aumentar suas chances de sucesso.</p>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Lobo -->
                                <div class="bg-sky-50 p-5 rounded-lg border border-sky-200">
                                    <h3 class="font-bold text-xl mb-3 flex items-center gap-2"><i class="ph-bold ph-user-focus text-sky-600"></i>LOBO</h3>
                                    <p class="text-gray-700 mt-1 mb-3">Disciplinado, observador e metódico. Organizado e capaz de criar planos para alcançar objetivos.</p>
                                    <p class="font-semibold">Como vender:</p>
                                    <ul class="list-disc list-inside text-gray-700 mt-1"><li>Apresente dados, fatos e lógica.</li><li>Seja preciso, direto e não pressione.</li><li>Dê tempo para ele analisar e decidir.</li></ul>
                                </div>
                                <!-- Gato -->
                                <div class="bg-amber-50 p-5 rounded-lg border border-amber-200">
                                    <h3 class="font-bold text-xl mb-3 flex items-center gap-2"><i class="ph-bold ph-chats text-amber-600"></i>GATO</h3>
                                    <p class="text-gray-700 mt-1 mb-3">Comunicador, diplomático e sociável. Fortalece relacionamentos e tem facilidade em lidar com clientes.</p>
                                    <p class="font-semibold">Como vender:</p>
                                    <ul class="list-disc list-inside text-gray-700 mt-1"><li>Crie rapport primeiro, construa confiança.</li><li>Use depoimentos de outros clientes felizes.</li><li>Dê garantias e segurança. Ele compra de quem confia.</li></ul>
                                </div>
                                <!-- Tubarão -->
                                <div class="bg-rose-50 p-5 rounded-lg border border-rose-200">
                                    <h3 class="font-bold text-xl mb-3 flex items-center gap-2"><i class="ph-bold ph-trend-up text-rose-600"></i>TUBARÃO</h3>
                                    <p class="text-gray-700 mt-1 mb-3">Focado em resultados e executor. Não deixa para amanhã e traz respostas rápidas para o serviço.</p>
                                    <p class="font-semibold">Como vender:</p>
                                    <ul class="list-disc list-inside text-gray-700 mt-1"><li>Seja rápido e vá direto ao ponto (objetivos).</li><li>Mostre como sua solução traz resultados mensuráveis.</li><li>Apresente opções para ele sentir que está no controle.</li></ul>
                                </div>
                                <!-- Águia -->
                                <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-200">
                                    <h3 class="font-bold text-xl mb-3 flex items-center gap-2"><i class="ph-bold ph-rocket-launch text-indigo-600"></i>ÁGUIA</h3>
                                    <p class="text-gray-700 mt-1 mb-3">Visão diferenciada e criatividade. Capaz de propor inovações e visualizar o futuro.</p>
                                    <p class="font-semibold">Como vender:</p>
                                    <ul class="list-disc list-inside text-gray-700 mt-1"><li>Mostre como sua solução é inovadora e visionária.</li><li>Deixe-o falar e elogie suas ideias.</li><li>Use visuais impactantes e foque nas possibilidades futuras.</li></ul>
                                </div>
                            </div>
                            <div class="mt-8">
                                <label class="font-bold text-xl mb-3 block">Anotações sobre o cliente atual:</label>
                                <textarea id="anotacoes_cliente" class="w-full mt-1 p-3 border border-gray-300 rounded-lg h-32" placeholder="Ex: O cliente João parece ser um LOBO. Focar em apresentar o ROI do projeto na próxima reunião..." oninput="window.debounceSaveNotes()"></textarea>
                            </div>
                        </div>
                        <div class="pt-10">
                            <h2 class="text-3xl font-bold mb-2">Guia de Quebra de Objeções</h2>
                            <p class="text-gray-600 mb-6">Use estes roteiros para transformar um "não" em uma oportunidade.</p>
                            <div class="space-y-4">
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"Está muito caro."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Eu entendo sua preocupação com o investimento, [Nome do Cliente]. É fundamental que cada real investido traga o máximo de retorno."</p>
                                        <p><strong>2. Isole a Objeção:</strong> "Só para eu entender melhor, a questão do valor é o único ponto que te impede de avançarmos agora? Se encontrarmos uma forma que se encaixe no seu orçamento, a solução atende ao que você precisa?"</p>
                                        <p><strong>3. Argumente com Valor (use as calculadoras!):</strong> "Vamos revisitar aquele cálculo de <strong>ROI</strong> que fizemos. O investimento se paga em X meses e, em 2 anos, gera um lucro de R$ Y para a sua empresa. Ou, se compararmos com a alternativa Z (<strong>TCO</strong>), nossa solução representa uma economia de R$ W no longo prazo. Não seria um custo, mas o caminho mais lucrativo."</p>
                                        <p><strong>4. Confirme:</strong> "Analisando por essa perspectiva de lucro/economia, o investimento não parece mais estratégico?"</p>
                                    </div>
                                </details>
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"Preciso pensar / Vou falar com meu sócio."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Claro, [Nome do Cliente]. Uma decisão como essa precisa ser bem pensada e alinhada com todos os envolvidos."</p>
                                        <p><strong>2. Isole a Objeção:</strong> "Para que você possa pensar com todas as informações na mão, existe algum ponto da proposta que não ficou 100% claro ou alguma dúvida que eu possa esclarecer agora?"</p>
                                        <p><strong>3. Argumente com Valor e Urgência (sutil):</strong> "Perfeito. Enquanto você e seu sócio analisam, posso te enviar o estudo de caso da empresa Y, que tinha um desafio parecido com o de vocês. Eles começaram a ver os primeiros resultados em Z dias. Apenas para seu conhecimento, nossa agenda de implementação para o próximo mês já está quase completa."</p>
                                        <p><strong>4. Defina o Próximo Passo:</strong> "Que tal agendarmos uma breve chamada na quarta-feira às 10h? Assim eu posso esclarecer qualquer dúvida que seu sócio tenha e podemos definir os próximos passos."</p>
                                    </div>
                                </details>
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"O concorrente X tem um preço menor."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Obrigado por compartilhar isso. A empresa X é uma boa empresa e é natural que você esteja comparando todas as opções."</p>
                                        <p><strong>2. Isole a Objeção:</strong> "Além do preço, existe algum outro fator na proposta deles que te agradou mais que a nossa?"</p>
                                        <p><strong>3. Argumente com Valor (use a TCO!):</strong> "Entendo que o preço inicial deles seja menor. Inclusive, podemos usar nossa calculadora de <strong>Custo Total de Propriedade (TCO)</strong>. A solução deles tem uma vida útil de Y anos e um custo de manutenção anual de R$ Z. A nossa, embora o investimento inicial seja um pouco maior, dura W anos e tem um custo anual de apenas R$ K. No final de 5 anos, a nossa solução representa uma economia de R$ X. O barato pode sair caro."</p>
                                        <p><strong>4. Confirme:</strong> "Pensando no longo prazo e na economia total, qual das duas opções parece ser o melhor investimento para sua empresa?"</p>
                                    </div>
                                </details>
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"Já temos uma solução / Estamos satisfeitos."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Fico feliz em saber que já têm uma solução para isso. Mostra que a empresa de vocês se preocupa com a eficiência."</p>
                                        <p><strong>2. Desafie sutilmente (curiosidade):</strong> "Só por curiosidade, se pudesse melhorar apenas uma coisa na sua solução atual, o que seria? Muitas empresas que usavam a solução Y, assim como vocês, vieram para a nossa por causa do [Mencione um diferencial chave]."</p>
                                        <p><strong>3. Argumente com Valor (diferencial):</strong> "A nossa abordagem é um pouco diferente. Enquanto a solução Y foca em A, nós focamos em B, o que para clientes como vocês resultou numa economia de Z% em custos operacionais (use dados do **ROI** ou **TCO**)."</p>
                                        <p><strong>4. Confirme:</strong> "Não gostaria de trocar a sua solução, mas talvez valesse a pena uma conversa de 15 minutos para ver se essa economia também se aplicaria ao seu negócio?"</p>
                                    </div>
                                </details>
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"Não tenho tempo para implementar isso agora."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Entendo perfeitamente, o dia a dia é corrido e a última coisa que queremos é um projeto que atrapalhe a operação."</p>
                                        <p><strong>2. Isole a Objeção:</strong> "Se a questão do tempo de implementação não fosse um problema, você estaria pronto para avançar?"</p>
                                        <p><strong>3. Argumente com Valor (facilidade):</strong> "Nós projetámos a nossa implementação para ser o mais simples possível. Na verdade, a nossa equipa cuida de 90% do processo, e da sua parte precisaríamos de apenas X horas na primeira semana. Muitos clientes relatam que o tempo que economizam já no primeiro mês (use o **ROI** para calcular isso) compensa largamente este investimento inicial de tempo."</p>
                                        <p><strong>4. Confirme:</strong> "O que acha de reservarmos uma data na sua agenda para daqui a 3 semanas? Assim não impacta as suas prioridades atuais e já garantimos o início do projeto para começar a gerar essa economia para si."</p>
                                    </div>
                                </details>
                                <details class="bg-gray-50 p-4 rounded-lg cursor-pointer group border">
                                    <summary class="font-semibold text-lg text-gray-800 group-open:text-blue-700">"Não tenho orçamento para isso este ano."</summary>
                                    <div class="mt-3 pt-3 border-t text-gray-700 space-y-2">
                                        <p><strong>1. Valide e Empatize:</strong> "Compreendo, o planeamento orçamental é uma parte crítica da gestão."</p>
                                        <p><strong>2. Isole a Objeção:</strong> "O orçamento é o único impedimento? Se encontrássemos uma forma de o encaixar, você veria valor na solução?"</p>
                                        <p><strong>3. Argumente com Valor (Custo de Não Fazer):</strong> "Muitas vezes, o custo de *não* resolver o problema de [Dor do Cliente] acaba por ser maior do que o investimento na solução. Com base no nosso cálculo de **ROI**, a sua empresa está a deixar de economizar/ganhar cerca de R$ Y por mês. Em 3 meses, o custo da ineficiência já seria maior que o investimento inicial."</p>
                                        <p><strong>4. Confirme (Ofereça alternativas):</strong> "Pensando nisso, talvez possamos explorar um plano de pagamento faseado ou iniciar com um projeto piloto de menor valor para que possa começar a ter o retorno ainda este ano. Faria sentido explorarmos essa possibilidade?"</p>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script type="module">
        // Importa as funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Variáveis Globais de Estado e Firebase ---
        let app, auth, db, appId, userId;
        let draggedCard = null;
        let lastCalcState = {};
        let currentCalcMode = 'lucratividade';
        let currentSubCalcMode = 'unico';
        window.cardIdCounter = 0; 
        let kanbanUnsubscribe = () => {};
        let notesUnsubscribe = () => {};
        let goalUnsubscribe = () => {};
        let taskUnsubscribe = () => {};
        let teamGoalUnsubscribe = () => {};
        let wonDealsUnsubscribe = () => {};
        let saveNotesTimeout;
        let saveGoalTimeout;
        let saveTeamGoalTimeout;
        let authReady = false;

        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBe9yjpAUXzNyCWZie2bbHd69D5uqDVqhM",
            authDomain: "vendasjd-7eaee.firebaseapp.com",
            projectId: "vendasjd-7eaee",
            storageBucket: "vendasjd-7eaee.appspot.com",
            messagingSenderId: "623306912799",
            appId: "1:623306912799:web:8cebe639870d79476e912a",
            measurementId: "G-JNJMYVRRRV"
        };
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'vendasjd-7eaee';


        // --- Funções de Lógica do Firebase (autenticação) ---
        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    errorDiv.textContent = 'Email ou senha inválidos.';
                });
        }
        function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const errorDiv = document.getElementById('registerError');
            errorDiv.textContent = '';
            if(password.length < 6) {
                errorDiv.textContent = 'A senha precisa de ter pelo menos 6 caracteres.';
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    if (error.code === 'auth/email-already-in-use') {
                        errorDiv.textContent = 'Este email já está a ser utilizado.';
                    } else {
                        errorDiv.textContent = 'Ocorreu um erro ao criar a conta.';
                    }
                });
        }
        function handleLogout() { signOut(auth); }
        function toggleAuthForms() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
            document.getElementById('loginError').textContent = '';
            document.getElementById('registerError').textContent = '';
        }

        // --- Funções Auxiliares de UI e Utilitários ---
        const formatCurrency = (value) => !isNaN(parseFloat(value)) ? parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
        
        function parseCurrency(value) {
            if (typeof value !== 'string') return parseFloat(value) || 0;
            return parseFloat(value.replace(/[^0-9,-]+/g,"").replace(",", ".")) || 0;
        }

        function formatInputCurrency(input) {
            if (!input) return;
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace(".", ",");
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            input.value = "R$ " + value;
        }

        function timeAgo(dateString, prefix = '') {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `${prefix} há ${Math.floor(interval)} anos`;
            interval = seconds / 2592000;
            if (interval > 1) return `${prefix} há ${Math.floor(interval)} meses`;
            interval = seconds / 86400;
            if (interval > 1) return `${prefix} há ${Math.floor(interval)} dias`;
            interval = seconds / 3600;
            if (interval > 1) return `${prefix} há ${Math.floor(interval)} horas`;
            interval = seconds / 60;
            if (interval > 1) return `${prefix} há ${Math.floor(interval)} min`;
            return `${prefix} há poucos seg.`;
        }
        
        function updateStatus(text, color = 'text-gray-500', showSpinner = true) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mr-2 ${showSpinner ? '' : 'hidden'}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="${color}">${text}</span>`;
            }
        }

        function resetUIState() {
            // Limpa o funil
            document.querySelectorAll('.kanban-cards').forEach(col => col.innerHTML = '');
            updateIndicators();
            // Limpa as tarefas
            document.getElementById('taskListContainer').innerHTML = '';
             // Limpa as anotações
            const noteIds = ['concorrente1_nome', 'concorrente1_fortes', 'concorrente1_fracos', 'concorrente2_nome', 'concorrente2_fortes', 'concorrente2_fracos', 'concorrente3_nome', 'concorrente3_fortes', 'concorrente3_fracos', 'anotacoes_cliente'];
            noteIds.forEach(id => document.getElementById(id).value = '');
            // Reseta metas
            document.getElementById('metaInput').value = '';
            document.getElementById('teamMetaInput').value = '';
            updateIndicators();
            updateTeamGoalProgress(0,0);
            // Limpa lista de vendas
            document.getElementById('wonDealsList').innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">Nenhuma venda ganha ainda.</td></tr>';
        }

        // --- Funções de Lógica do Firebase (Firestore) ---
        async function saveKanbanState() {
            if (!userId) return;
            updateStatus('A salvar funil...', 'text-yellow-600');
            const boardState = { columns: {} };
            document.querySelectorAll('.kanban-column').forEach(column => {
                const columnId = column.dataset.column;
                const cards = [];
                column.querySelectorAll('.kanban-card').forEach(card => {
                    cards.push({
                        id: card.id,
                        title: card.querySelector('.card-title-input').value,
                        company: card.querySelector('.card-company-input').value,
                        contact: card.querySelector('.card-contact-input').value,
                        date: card.querySelector('.card-date-input').value,
                        notes: card.querySelector('.card-notes-input').value,
                        value: parseCurrency(card.querySelector('.card-value-input').value),
                        createdAt: card.dataset.createdAt,
                        stageHistory: JSON.parse(card.dataset.stageHistory)
                    });
                });
                boardState.columns[columnId] = cards;
            });
            const kanbanDocRef = doc(db, `artifacts/${appId}/users/${userId}/kanban`, 'boardState');
            try {
                await setDoc(kanbanDocRef, { board: JSON.stringify(boardState) });
                updateStatus('Salvo', 'text-green-600', false);
            } catch (error) {
                console.error("Erro ao salvar o funil:", error);
                updateStatus('Erro ao salvar', 'text-red-600', false);
            }
        }

        function loadKanbanState(data) {
            const kanbanCardsContainer = document.querySelector('.kanban-cards');
            if (!kanbanCardsContainer) return;
            document.querySelectorAll('.kanban-cards').forEach(col => col.innerHTML = ''); // Limpa antes de carregar
            if (data && data.board) {
                const boardState = JSON.parse(data.board);
                let maxId = 0;
                Object.keys(boardState.columns).forEach(columnId => {
                    const columnEl = document.querySelector(`.kanban-column[data-column="${columnId}"] .kanban-cards`);
                    if (columnEl) {
                        boardState.columns[columnId].forEach(cardData => {
                            const card = document.createElement('div');
                            card.className = 'kanban-card'; card.draggable = true; card.id = cardData.id;
                            card.dataset.createdAt = cardData.createdAt;
                            card.dataset.stageHistory = JSON.stringify(cardData.stageHistory);
                             card.innerHTML = `
                                <button onclick="window.deleteCard('${cardData.id}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-50 z-10"><i class="ph ph-trash"></i></button>
                                <input type="text" class="card-title-input font-semibold w-full bg-transparent focus:bg-white focus:ring-1 focus:ring-blue-500 rounded px-1 -mx-1" value="${cardData.title || ''}" onblur="window.saveKanbanState()">
                                <div class="mt-2 space-y-2 text-sm">
                                    <div class="flex items-center gap-2"><i class="ph ph-buildings text-gray-500"></i><input type="text" class="card-company-input card-details-input" placeholder="Empresa" value="${cardData.company || ''}" onblur="window.saveKanbanState()"></div>
                                    <div class="flex items-center gap-2"><i class="ph ph-user text-gray-500"></i><input type="text" class="card-contact-input card-details-input" placeholder="Contato" value="${cardData.contact || ''}" onblur="window.saveKanbanState()"></div>
                                    <div class="flex items-center gap-2"><i class="ph ph-calendar text-gray-500"></i><input type="text" class="card-date-input card-details-input" placeholder="Data (dd/mm/aa)" value="${cardData.date || ''}" onblur="window.saveKanbanState()"></div>
                                    <div class="flex items-start gap-2"><i class="ph ph-note-pencil text-gray-500 mt-1"></i><textarea class="card-notes-input card-details-input h-16" placeholder="Anotações..." onblur="window.saveKanbanState()">${cardData.notes || ''}</textarea></div>
                                </div>
                                <div class="mt-3 pt-3 border-t">
                                    <label class="text-xs font-medium text-gray-500">Valor do Negócio</label>
                                    <input type="text" class="card-value-input" value="${formatCurrency(cardData.value || 0)}" placeholder="R$ 0,00" oninput="window.formatInputCurrency(this); window.updateIndicators();" onblur="window.saveKanbanState()">
                                </div>
                                <div class="mt-2 text-xs text-gray-400 flex justify-between">
                                    <span class="card-created-date">${timeAgo(cardData.createdAt, 'Criado')}</span>
                                    <span class="card-stage-time">${timeAgo(cardData.stageHistory[cardData.stageHistory.length - 1].movedAt, 'Nesta fase')}</span>
                                </div>`;
                            addCardEventListeners(card);
                            columnEl.appendChild(card);
                            const currentId = parseInt(cardData.id.split('-')[1]);
                            if (currentId > maxId) maxId = currentId;
                        });
                    }
                });
                window.cardIdCounter = maxId;
            }
            updateIndicators();
        }

        async function saveNotesState() {
            if (!userId) return;
            updateStatus('A salvar anotações...', 'text-yellow-600');
            const notes = {
                concorrente1_nome: document.getElementById('concorrente1_nome').value,
                concorrente1_fortes: document.getElementById('concorrente1_fortes').value,
                concorrente1_fracos: document.getElementById('concorrente1_fracos').value,
                concorrente2_nome: document.getElementById('concorrente2_nome').value,
                concorrente2_fortes: document.getElementById('concorrente2_fortes').value,
                concorrente2_fracos: document.getElementById('concorrente2_fracos').value,
                concorrente3_nome: document.getElementById('concorrente3_nome').value,
                concorrente3_fortes: document.getElementById('concorrente3_fortes').value,
                concorrente3_fracos: document.getElementById('concorrente3_fracos').value,
                anotacoes_cliente: document.getElementById('anotacoes_cliente').value
            };
            const notesDocRef = doc(db, `artifacts/${appId}/users/${userId}/notes`, 'allNotes');
            try {
                await setDoc(notesDocRef, notes);
                updateStatus('Salvo', 'text-green-600', false);
            } catch (error) {
                console.error("Erro ao salvar anotações:", error);
                updateStatus('Erro ao salvar', 'text-red-600', false);
            }
        }
        
        function debounceSaveNotes() {
            clearTimeout(saveNotesTimeout);
            saveNotesTimeout = setTimeout(saveNotesState, 1500);
        }

        function loadNotesState(data) {
             if (data) {
                 document.getElementById('concorrente1_nome').value = data.concorrente1_nome || '';
                 document.getElementById('concorrente1_fortes').value = data.concorrente1_fortes || '';
                 document.getElementById('concorrente1_fracos').value = data.concorrente1_fracos || '';
                 document.getElementById('concorrente2_nome').value = data.concorrente2_nome || '';
                 document.getElementById('concorrente2_fortes').value = data.concorrente2_fortes || '';
                 document.getElementById('concorrente2_fracos').value = data.concorrente2_fracos || '';
                 document.getElementById('concorrente3_nome').value = data.concorrente3_nome || '';
                 document.getElementById('concorrente3_fortes').value = data.concorrente3_fortes || '';
                 document.getElementById('concorrente3_fracos').value = data.concorrente3_fracos || '';
                 document.getElementById('anotacoes_cliente').value = data.anotacoes_cliente || '';
             }
        }

        async function saveGoalState() {
            if (!userId) return;
            updateStatus('A salvar meta...', 'text-yellow-600');
            const metaValue = parseCurrency(document.getElementById('metaInput').value);
            const goalDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'goal');
            try {
                await setDoc(goalDocRef, { value: metaValue });
                updateStatus('Salvo', 'text-green-600', false);
            } catch (error) {
                console.error("Erro ao salvar a meta:", error);
                updateStatus('Erro ao salvar', 'text-red-600', false);
            }
        }

        function debounceSaveGoal() {
            clearTimeout(saveGoalTimeout);
            saveGoalTimeout = setTimeout(saveGoalState, 1500);
        }

        function loadGoalState(data) {
            if (data && data.value) {
                document.getElementById('metaInput').value = formatCurrency(data.value);
            }
            updateIndicators();
        }

        async function saveTasksState() {
             if (!userId) return;
            updateStatus('A salvar tarefas...', 'text-yellow-600');
            const tasks = [];
            document.querySelectorAll('#taskListContainer .task-item').forEach(taskEl => {
                tasks.push({
                    id: taskEl.id,
                    text: taskEl.querySelector('span').textContent,
                    completed: taskEl.classList.contains('completed')
                });
            });
            const tasksDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, 'taskList');
            try {
                await setDoc(tasksDocRef, { tasks });
                 updateStatus('Salvo', 'text-green-600', false);
            } catch (error) {
                console.error("Erro ao salvar tarefas:", error);
                updateStatus('Erro ao salvar', 'text-red-600', false);
            }
        }

        function loadTasksState(data) {
            const taskListContainer = document.getElementById('taskListContainer');
            taskListContainer.innerHTML = '';
            if (data && data.tasks) {
                data.tasks.forEach(taskData => {
                    const taskEl = document.createElement('div');
                    taskEl.id = taskData.id;
                    taskEl.className = `task-item flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${taskData.completed ? 'completed' : ''}`;
                    taskEl.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" ${taskData.completed ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" onclick="window.toggleTaskCompletion('${taskData.id}')">
                            <span class="flex-grow">${taskData.text}</span>
                        </div>
                        <button onclick="window.deleteTask('${taskData.id}')" class="text-gray-400 hover:text-red-600"><i class="ph-bold ph-trash"></i></button>
                    `;
                    taskListContainer.appendChild(taskEl);
                });
            }
        }
        
        // --- Funções da Aplicação ---
        
        function changeTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        function changeCalcMode(mode) {
            currentCalcMode = mode;
            document.getElementById('modoLucratividade').classList.add('hidden');
            document.getElementById('calcModoRoi').classList.add('hidden');
            document.getElementById('calcModoTco').classList.add('hidden');
            document.querySelectorAll('.calc-mode-btn').forEach(btn => btn.classList.remove('active'));

            if (mode === 'lucratividade') {
                document.getElementById('modoLucratividade').classList.remove('hidden');
                document.getElementById('simuladorNegociacao').classList.remove('hidden');
                document.getElementById('btnLucratividade').classList.add('active');
            } else if (mode === 'roi') {
                 document.getElementById('calcModoRoi').classList.remove('hidden');
                 document.getElementById('btnRoi').classList.add('active');
                 document.getElementById('resultadoAnalise').innerHTML = '<p class="text-gray-500 text-center py-10">Preencha os campos da Calculadora de ROI e veja os resultados aqui.</p>';
                 document.getElementById('simuladorNegociacao').classList.add('hidden');
            } else if (mode === 'tco') {
                document.getElementById('calcModoTco').classList.remove('hidden');
                document.getElementById('btnTco').classList.add('active');
                document.getElementById('resultadoAnalise').innerHTML = '<p class="text-gray-500 text-center py-10">Preencha os campos da Calculadora de TCO e veja os resultados aqui.</p>';
                document.getElementById('simuladorNegociacao').classList.add('hidden');
            }
        }

        function changeSubCalcMode(subMode) {
            currentSubCalcMode = subMode;
             if (subMode === 'unico') {
                document.getElementById('calcModoUnico').classList.remove('hidden');
                document.getElementById('calcModoKit').classList.add('hidden');
                document.getElementById('btnProdutoUnico').classList.add('active');
                document.getElementById('btnKit').classList.remove('active');
            } else {
                document.getElementById('calcModoUnico').classList.add('hidden');
                document.getElementById('calcModoKit').classList.remove('hidden');
                document.getElementById('btnProdutoUnico').classList.remove('active');
                document.getElementById('btnKit').classList.add('active');
            }
        }

        function adicionarItemKit() {
            const nomeInput = document.getElementById('kitItemNome');
            const custoInput = document.getElementById('kitItemCusto');
            const qtdInput = document.getElementById('kitItemQtd');
            const ipiInput = document.getElementById('kitItemIPI');
            const icmsInput = document.getElementById('kitItemICMS');

            const nome = nomeInput.value.trim();
            const custo = parseFloat(custoInput.value) || 0;
            const qtd = parseInt(qtdInput.value) || 1;
            const ipi = parseFloat(ipiInput.value) || 0;
            const icms = parseFloat(icmsInput.value) || 0;

            if (!nome || custo <= 0) {
                // Substituindo alert por uma UI mais amigável
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-red-500 text-center text-sm my-2';
                errorDiv.textContent = 'Por favor, preencha o nome e um custo válido.';
                nomeInput.parentElement.parentElement.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 3000);
                return;
            }

            const container = document.getElementById('itensKitContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'kit-item flex items-center gap-2 bg-white p-2 rounded-md border';
            itemDiv.dataset.custo = custo;
            itemDiv.dataset.qtd = qtd;
            itemDiv.dataset.ipi = ipi;
            itemDiv.dataset.icms = icms;

            const custoFinalItem = (custo / (1 - icms / 100)) * (1 + ipi / 100);

            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold">${nome} (x${qtd})</p>
                    <p class="text-xs text-gray-500">Custo c/ Impostos: ${formatCurrency(custoFinalItem * qtd)}</p>
                </div>
                <button onclick="this.parentElement.remove(); window.atualizarCustoTotalKit();" class="text-red-500 hover:text-red-700 p-1"><i class="ph-bold ph-trash"></i></button>
            `;
            container.appendChild(itemDiv);

            nomeInput.value = '';
            custoInput.value = '';
            qtdInput.value = '1';
            ipiInput.value = '';
            icmsInput.value = '';
            nomeInput.focus();
            atualizarCustoTotalKit();
        }

        function atualizarCustoTotalKit() {
            let custoTotal = 0;
            document.querySelectorAll('.kit-item').forEach(item => {
                const custo = parseFloat(item.dataset.custo) || 0;
                const qtd = parseInt(item.dataset.qtd) || 0;
                const ipi = parseFloat(item.dataset.ipi) || 0;
                const icms = parseFloat(item.dataset.icms) || 0;
                const custoFinalItem = (custo / (1 - icms / 100)) * (1 + ipi / 100);
                custoTotal += custoFinalItem * qtd;
            });
            document.getElementById('custoTotalKit').textContent = formatCurrency(custoTotal);
        }

        function recalcularSinal() {
            const { custoTotalDireto } = lastCalcState;
            if (custoTotalDireto === undefined || custoTotalDireto <= 0) {
                const container = document.getElementById('valorSinalContainer');
                if (container) container.innerHTML = '';
                return;
            }

            const percentual = parseFloat(document.getElementById('sinalPercentual').value) || 0;
            const valorSinal = custoTotalDireto * (percentual / 100);

            const container = document.getElementById('valorSinalContainer');
            if (container) {
                 container.innerHTML = `
                    <div class="indicator-card text-center bg-yellow-50 border-yellow-200">
                        <p class="text-sm text-yellow-800">Valor do Sinal (${percentual}%)</p>
                        <p class="text-2xl font-bold text-yellow-700">${formatCurrency(valorSinal)}</p>
                    </div>`;
            }
        }
        
        function analiseFinanceira(modo) {
            let custoTotalDireto = 0;
            let custoProduto = 0;
            let percImpostos = 0, percTaxaPagamento, percComissao, percCustoFixo;

            if (currentSubCalcMode === 'unico') {
                custoProduto = parseFloat(document.getElementById('custoProduto').value) || 0;
                const impostosRecuperaveis = parseFloat(document.getElementById('impostosRecuperaveis').value) || 0;
                const frete = parseFloat(document.getElementById('frete').value) || 0;
                custoTotalDireto = custoProduto + frete - impostosRecuperaveis;
                percImpostos = parseFloat(document.getElementById('impostosVenda').value) || 0;
                percTaxaPagamento = parseFloat(document.getElementById('taxaPagamentoUnico').value) || 0;
                percComissao = parseFloat(document.getElementById('comissaoUnico').value) || 0;
                percCustoFixo = parseFloat(document.getElementById('custoFixoUnico').value) || 0;
            } else { 
                 document.querySelectorAll('.kit-item').forEach(item => {
                    const custo = parseFloat(item.dataset.custo) || 0;
                    const qtd = parseInt(item.dataset.qtd) || 0;
                    const ipi = parseFloat(item.dataset.ipi) || 0;
                    const icms = parseFloat(item.dataset.icms) || 0;
                    const custoFinalItem = (custo / (1 - icms / 100)) * (1 + ipi / 100);
                    custoTotalDireto += custoFinalItem * qtd;
                    custoProduto += custo * qtd;
                });
                percTaxaPagamento = parseFloat(document.getElementById('taxaPagamentoKit').value) || 0;
                percComissao = parseFloat(document.getElementById('comissaoKit').value) || 0;
                percCustoFixo = parseFloat(document.getElementById('custoFixoKit').value) || 0;
            }
            
            const precoVendaInput = document.getElementById('precoVenda');
            const margemLucroInput = document.getElementById('margemLucro');
            const res = document.getElementById('resultadoAnalise');
            const simulador = document.getElementById('simuladorNegociacao');

            res.innerHTML = '';
            simulador.classList.add('hidden');
            lastCalcState = {};

            if (custoTotalDireto <= 0) {
                 res.innerHTML = `<p class="font-bold text-red-600 text-center py-10">O Custo Efetivo (Custo - Impostos Recuperáveis) deve ser maior que zero.</p>`;
                 return;
            }

            const totalPercentuaisVariaveis = (currentSubCalcMode === 'unico' ? percImpostos : 0) + percTaxaPagamento + percComissao + percCustoFixo;
            let precoVendaFinal = 0;
            let margemLucroFinal = 0;

            if (modo === 'precificar') {
                const percLucroDesejado = parseFloat(margemLucroInput.value) || 0;
                const totalPercentuais = totalPercentuaisVariaveis + percLucroDesejado;
                if (totalPercentuais >= 100) {
                    res.innerHTML = `<p class="font-bold text-red-600 text-center py-10">A soma de todos os percentuais (despesas + lucro) não pode ser 100% ou mais.</p>`;
                    return;
                }
                const markupDivisor = 1 - (totalPercentuais / 100);
                precoVendaFinal = custoTotalDireto / markupDivisor;
                margemLucroFinal = percLucroDesejado;
                precoVendaInput.value = precoVendaFinal.toFixed(2);
            } else { 
                precoVendaFinal = parseFloat(precoVendaInput.value) || 0;
                if (precoVendaFinal <= custoTotalDireto) {
                     res.innerHTML = `<p class="font-bold text-red-600 text-center py-10">O preço de venda deve ser maior que a soma dos custos efetivos.</p>`;
                    return;
                }
                const valorDespesasVariaveis = precoVendaFinal * (totalPercentuaisVariaveis / 100);
                const lucroLiquido = precoVendaFinal - custoTotalDireto - valorDespesasVariaveis;
                margemLucroFinal = (lucroLiquido / precoVendaFinal) * 100;
                margemLucroInput.value = margemLucroFinal.toFixed(2);
            }

            const valorImpostos = (currentSubCalcMode === 'unico') ? precoVendaFinal * (percImpostos / 100) : custoTotalDireto - custoProduto;
            const valorTaxaPagamento = precoVendaFinal * (percTaxaPagamento / 100);
            const valorComissao = precoVendaFinal * (percComissao / 100);
            const valorCustoFixo = precoVendaFinal * (percCustoFixo / 100);
            const lucroLiquidoFinal = precoVendaFinal - custoTotalDireto - valorImpostos - valorTaxaPagamento - valorComissao - valorCustoFixo;
            const totalCustosDespesas = custoTotalDireto + valorImpostos + valorTaxaPagamento + valorComissao + valorCustoFixo;
            const markupMultiplicador = (custoProduto > 0) ? precoVendaFinal / custoProduto : 0;
            const percCustoProduto = (precoVendaFinal > 0) ? (custoTotalDireto / precoVendaFinal) * 100 : 0;
            const percDespesasTotais = (precoVendaFinal > 0) ? ((totalCustosDespesas - custoTotalDireto) / precoVendaFinal) * 100 : 0;
            const percLucro = (precoVendaFinal > 0) ? (lucroLiquidoFinal / precoVendaFinal) * 100 : 0;

            res.innerHTML = `
                <h3 class="font-bold text-lg mb-4">Análise da Venda</h3>
                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">Composição do Preço de Venda (${formatCurrency(precoVendaFinal)})</p>
                    <div class="w-full bg-gray-200 rounded-full h-6 flex overflow-hidden">
                        <div class="bg-slate-500 h-6 text-white text-xs flex items-center justify-center" style="width: ${percCustoProduto}%" title="Custos Diretos: ${percCustoProduto.toFixed(1)}%">${percCustoProduto > 10 ? percCustoProduto.toFixed(0)+'%' : ''}</div>
                        <div class="bg-amber-500 h-6 text-white text-xs flex items-center justify-center" style="width: ${percDespesasTotais}%" title="Despesas: ${percDespesasTotais.toFixed(1)}%">${percDespesasTotais > 10 ? percDespesasTotais.toFixed(0)+'%' : ''}</div>
                        <div class="bg-emerald-500 h-6 text-white text-xs flex items-center justify-center" style="width: ${percLucro}%" title="Lucro Líquido: ${percLucro.toFixed(1)}%">${percLucro > 10 ? percLucro.toFixed(0)+'%' : ''}</div>
                    </div>
                    <div class="flex flex-wrap justify-start gap-4 mt-2 text-xs">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-slate-500"></span>Custos Diretos Efetivos</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-500"></span>Despesas</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-emerald-500"></span>Lucro Líquido</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mt-4 mb-2">Detalhamento dos Valores:</h4>
                    <ul class="text-sm space-y-2 text-gray-700">
                        <li class="flex justify-between border-b pb-1"><span>(-) Custos Totais Efetivos:</span> <span class="font-medium">${formatCurrency(custoTotalDireto)}</span></li>
                        <li class="flex justify-between border-b pb-1"><span>(-) Impostos Sobre a Venda:</span> <span class="font-medium">${formatCurrency(valorImpostos)}</span></li>
                        <li class="flex justify-between border-b pb-1"><span>(-) Taxa de Pagamento (${percTaxaPagamento.toFixed(2).replace('.',',')}%):</span> <span class="font-medium">${formatCurrency(valorTaxaPagamento)}</span></li>
                        <li class="flex justify-between border-b pb-1"><span>(-) Comissão (${percComissao.toFixed(2).replace('.',',')}%):</span> <span class="font-medium">${formatCurrency(valorComissao)}</span></li>
                        <li class="flex justify-between border-b pb-1"><span>(-) Rateio Custo Fixo (${percCustoFixo.toFixed(2).replace('.',',')}%):</span> <span class="font-medium">${formatCurrency(valorCustoFixo)}</span></li>
                        <li class="flex justify-between pt-2 border-t mt-2 font-bold text-emerald-600"><span>(=) Lucro Líquido:</span> <span>${formatCurrency(lucroLiquidoFinal)}</span></li>
                    </ul>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 mt-4">
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Lucro Líquido</p><p class="text-2xl font-bold text-emerald-600">${formatCurrency(lucroLiquidoFinal)}</p></div>
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Margem de Lucro</p><p class="text-2xl font-bold text-blue-600">${margemLucroFinal.toFixed(2).replace('.', ',')}%</p></div>
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Custo Total da Venda</p><p class="text-2xl font-bold text-slate-600">${formatCurrency(totalCustosDespesas)}</p></div>
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Markup Multiplicador</p><p class="text-2xl font-bold text-indigo-600">${markupMultiplicador.toFixed(2)}x</p></div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <h4 class="font-semibold text-gray-800 mb-2">Desembolso de Caixa (Sinal)</h4>
                    <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                        <label for="sinalPercentual" class="text-sm whitespace-nowrap">Sugerir sinal de:</label>
                        <input type="number" id="sinalPercentual" class="w-20 px-2 py-1 border border-gray-300 rounded-md" value="30" oninput="window.recalcularSinal()">
                        <label for="sinalPercentual" class="text-sm">% do Custo Efetivo</label>
                    </div>
                    <div id="valorSinalContainer" class="mt-2">
                        <!-- Result will be injected here by JS -->
                    </div>
                </div>
            `;
            
            lastCalcState = { precoVendaFinal, custoTotalDireto, totalPercentuaisVariaveis, lucroLiquidoFinal, valorTaxaPagamento, valorImpostos };
            simulador.classList.remove('hidden');
            document.getElementById('resultadoSimularDesconto').innerHTML = '';
            document.getElementById('simularDescontoInput').value = '';
            document.getElementById('resultadoDescontoMaximo').innerHTML = '';
            document.getElementById('descontoMaximoInput').value = '';
            document.getElementById('resultadoParcelamento').innerHTML = '';
            document.getElementById('numParcelasInput').value = '';
            document.getElementById('taxaParcelamentoInput').value = '';
            recalcularSinal();
        }
        
        function usarUltimoPreco() {
            if (lastCalcState.precoVendaFinal) {
                document.getElementById('roiInvestimento').value = lastCalcState.precoVendaFinal.toFixed(2);
            } else {
                 const errorDiv = document.createElement('div');
                errorDiv.className = 'text-red-500 text-center text-sm my-2';
                errorDiv.textContent = 'Primeiro, calcule um preço na aba de Lucratividade.';
                document.getElementById('calcModoRoi').appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 3000);
            }
        }

        function calcularRoi() {
            const investimento = parseFloat(document.getElementById('roiInvestimento').value) || 0;
            const ganhosMensais = parseFloat(document.getElementById('roiGanhos').value) || 0;
            const custoMensal = parseFloat(document.getElementById('roiCustoMensal').value) || 0;
            const periodoAnalise = parseInt(document.getElementById('roiPeriodo').value) || 12;
            const resDiv = document.getElementById('resultadoAnalise');

            if (investimento <= 0 || ganhosMensais <= 0) {
                resDiv.innerHTML = `<p class="font-bold text-red-600 text-center py-10">O Investimento e os Ganhos Mensais devem ser maiores que zero.</p>`;
                return;
            }

            const ganhoLiquidoMensal = ganhosMensais - custoMensal;

            if (ganhoLiquidoMensal <= 0) {
                 resDiv.innerHTML = `<p class="font-bold text-amber-600 text-center py-10">O ganho mensal do cliente deve ser maior que o custo mensal da solução para haver retorno.</p>`;
                return;
            }

            const paybackMeses = investimento / ganhoLiquidoMensal;
            const ganhoTotalPeriodo = ganhoLiquidoMensal * periodoAnalise;
            const lucroClientePeriodo = ganhoTotalPeriodo - investimento;
            const roiPeriodo = (lucroClientePeriodo / investimento) * 100;

            resDiv.innerHTML = `
                <h3 class="font-bold text-lg mb-4 text-teal-700">Resultados de ROI para o Cliente</h3>
                <div class="space-y-4">
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Tempo de Retorno (Payback)</p><p class="text-2xl font-bold text-teal-600">${paybackMeses.toFixed(1).replace('.',',')} meses</p></div>
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">ROI em ${periodoAnalise} Meses</p><p class="text-2xl font-bold text-teal-600">+${roiPeriodo.toFixed(2).replace('.',',')}%</p></div>
                    <div class="indicator-card text-center"><p class="text-sm text-gray-500">Lucro do Cliente (em ${periodoAnalise} meses)</p><p class="text-2xl font-bold text-teal-600">${formatCurrency(lucroClientePeriodo)}</p></div>
                </div>
                 <p class="text-xs text-center text-gray-500 mt-4">"Com este investimento, em ${periodoAnalise} meses terá um retorno de ${roiPeriodo.toFixed(0)}% e um lucro de ${formatCurrency(lucroClientePeriodo)}."</p>
            `;
        }

         function calcularTco() {
            const resDiv = document.getElementById('resultadoAnalise');

            const precoA = parseCurrency(document.getElementById('tcoPrecoA').value) || 0;
            const manutencaoA = parseCurrency(document.getElementById('tcoManutencaoA').value) || 0;
            const vidaUtilA = parseInt(document.getElementById('tcoVidaUtilA').value) || 1;

            const precoB = parseCurrency(document.getElementById('tcoPrecoB').value) || 0;
            const manutencaoB = parseCurrency(document.getElementById('tcoManutencaoB').value) || 0;
            const vidaUtilB = parseInt(document.getElementById('tcoVidaUtilB').value) || 1;

            if (precoA <= 0 || precoB <= 0) {
                resDiv.innerHTML = `<p class="font-bold text-red-600 text-center py-10">O preço de compra de ambas as soluções deve ser maior que zero.</p>`;
                return;
            }

            const periodo = Math.max(vidaUtilA, vidaUtilB);

            const tcoA = precoA + (manutencaoA * vidaUtilA);
            const tcoB = precoB + (manutencaoB * vidaUtilB);
            
            const custoAnualA = tcoA / vidaUtilA;
            const custoAnualB = tcoB / vidaUtilB;
            const tcoAjustadoA = custoAnualA * periodo;
            const tcoAjustadoB = custoAnualB * periodo;

            const economiaTotal = tcoAjustadoB - tcoAjustadoA;
            
            const maxTco = Math.max(tcoAjustadoA, tcoAjustadoB);
            const percA = (tcoAjustadoA / maxTco) * 100;
            const percB = (tcoAjustadoB / maxTco) * 100;

            resDiv.innerHTML = `
                <h3 class="font-bold text-lg mb-4 text-purple-700">Análise de Custo Total (TCO) em ${periodo} anos</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">Sua Solução</span>
                            <span class="font-bold text-blue-600">${formatCurrency(tcoAjustadoA)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-5"><div class="bg-blue-600 h-5 rounded-full" style="width: ${percA}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">Concorrente</span>
                            <span class="font-bold text-gray-600">${formatCurrency(tcoAjustadoB)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-5"><div class="bg-gray-500 h-5 rounded-full" style="width: ${percB}%"></div></div>
                    </div>

                    <div class="indicator-card text-center !mt-6 ${economiaTotal >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-rose-50 border-rose-200'}">
                        <p class="text-sm ${economiaTotal >= 0 ? 'text-emerald-800' : 'text-rose-800'}">Economia para o cliente em ${periodo} anos</p>
                        <p class="text-3xl font-bold ${economiaTotal >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${formatCurrency(economiaTotal)}</p>
                    </div>
                </div>
                 <p class="text-xs text-center text-gray-500 mt-4">"Embora o preço inicial possa ser diferente, ao longo de ${periodo} anos, a nossa solução representa uma economia de ${formatCurrency(economiaTotal)} para a sua empresa."</p>
            `;
        }


        function simularDesconto() {
            const { precoVendaFinal, custoTotalDireto, totalPercentuaisVariaveis, valorImpostos } = lastCalcState;
            if (!precoVendaFinal) return; 

            const resDiv = document.getElementById('resultadoSimularDesconto');
            const descontoPerc = parseFloat(document.getElementById('simularDescontoInput').value) || 0;

            if (descontoPerc < 0 || descontoPerc > 100) {
                resDiv.innerHTML = `<p class="text-red-600 font-semibold text-center mt-2">O desconto deve ser entre 0% e 100%.</p>`;
                return;
            }

            const novoPrecoVenda = precoVendaFinal * (1 - (descontoPerc / 100));
            // Recalcular despesas com base no novo preço
            const novasDespesasVariaveis = novoPrecoVenda * (totalPercentuaisVariaveis / 100);
            const novoLucroLiquido = novoPrecoVenda - custoTotalDireto - novasDespesasVariaveis;
            const novaMargem = (novoPrecoVenda > 0) ? (novoLucroLiquido / novoPrecoVenda) * 100 : 0;


            resDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3 text-center">
                    <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Novo Preço</p><p class="font-bold text-indigo-600">${formatCurrency(novoPrecoVenda)}</p></div>
                    <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Novo Lucro</p><p class="font-bold ${novoLucroLiquido >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatCurrency(novoLucroLiquido)}</p></div>
                    <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Nova Margem</p><p class="font-bold ${novaMargem >= 0 ? 'text-blue-600' : 'text-red-600'}">${novaMargem.toFixed(2).replace('.',',')}%</p></div>
                </div>
            `;
        }

        function calcularDescontoMaximo() {
            const { precoVendaFinal, custoTotalDireto, totalPercentuaisVariaveis } = lastCalcState;
            if (!precoVendaFinal) return;

            const resDiv = document.getElementById('resultadoDescontoMaximo');
            const margemMinima = parseFloat(document.getElementById('descontoMaximoInput').value) || 0;
            
            const divisor = 1 - (totalPercentuaisVariaveis / 100) - (margemMinima / 100);

            if (divisor <= 0) {
                resDiv.innerHTML = `<p class="text-red-600 font-semibold text-center mt-2">Margem mínima muito alta. A soma das despesas e da margem não pode ser 100% ou mais.</p>`;
                return;
            }
            
            const precoMinimo = custoTotalDireto / divisor;

            if (precoMinimo > precoVendaFinal) {
                 resDiv.innerHTML = `<p class="text-amber-600 font-semibold text-center mt-2">A margem atual já é menor que a mínima desejada. Não é possível dar desconto.</p>`;
                return;
            }

            const descontoMaximoPerc = ((precoVendaFinal - precoMinimo) / precoVendaFinal) * 100;

             resDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 text-center">
                    <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Desconto Máximo</p><p class="font-bold text-rose-600">${descontoMaximoPerc.toFixed(2).replace('.',',')}%</p></div>
                    <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Preço Final Mínimo</p><p class="font-bold text-slate-600">${formatCurrency(precoMinimo)}</p></div>
                </div>
            `;
        }
        
        function calcularParcelamento() {
            const { precoVendaFinal, lucroLiquidoFinal, valorTaxaPagamento } = lastCalcState;
            if (!precoVendaFinal) return;

            const resDiv = document.getElementById('resultadoParcelamento');
            const numParcelas = parseInt(document.getElementById('numParcelasInput').value) || 1;
            const taxaParcelamento = parseFloat(document.getElementById('taxaParcelamentoInput').value) || 0;
            const quemPaga = document.querySelector('.quem-paga-btn.active').dataset.value;

            if (numParcelas <= 0) {
                resDiv.innerHTML = `<p class="text-red-600 font-semibold text-center mt-2">O número de parcelas deve ser maior que zero.</p>`;
                return;
            }

            if (quemPaga === 'empresa') {
                const valorParcela = precoVendaFinal / numParcelas;
                const valorNovaTaxa = precoVendaFinal * (taxaParcelamento / 100);
                const diferencaDeCusto = valorNovaTaxa - valorTaxaPagamento;
                const novoLucro = lucroLiquidoFinal - diferencaDeCusto;
                const novaMargem = (precoVendaFinal > 0) ? (novoLucro / precoVendaFinal) * 100 : 0;
                const mudancaCustoTexto = diferencaDeCusto > 0 
                    ? `<p class="text-xs text-center text-red-600 mt-2">Custo adicional da taxa: ${formatCurrency(diferencaDeCusto)}</p>` 
                    : (diferencaDeCusto < 0 ? `<p class="text-xs text-center text-emerald-600 mt-2">Economia na taxa: ${formatCurrency(-diferencaDeCusto)}</p>` : '');

                resDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 text-center">
                        <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Valor da Parcela</p><p class="font-bold text-cyan-600">${numParcelas}x de ${formatCurrency(valorParcela)}</p></div>
                        <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Lucro Real</p><p class="font-bold ${novoLucro >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatCurrency(novoLucro)}</p></div>
                        <div class="bg-white p-2 rounded-md md:col-span-2"><p class="text-xs text-gray-500">Margem Real</p><p class="font-bold ${novaMargem >= 0 ? 'text-blue-600' : 'text-red-600'}">${novaMargem.toFixed(2).replace('.',',')}%</p></div>
                    </div>
                    ${mudancaCustoTexto}
                `;
            } else { 
                const valorTaxaAbsoluto = precoVendaFinal / (1 - (taxaParcelamento/100)) - precoVendaFinal;
                const novoPrecoCliente = precoVendaFinal + valorTaxaAbsoluto;
                const valorParcela = novoPrecoCliente / numParcelas;
                
                resDiv.innerHTML = `
                    <div class="bg-white p-2 rounded-md text-center">
                        <p class="text-xs text-gray-500">Novo Preço Final (p/ Cliente)</p>
                        <p class="font-bold text-indigo-600">${formatCurrency(novoPrecoCliente)}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-center">
                        <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Valor da Parcela</p><p class="font-bold text-cyan-600">${numParcelas}x de ${formatCurrency(valorParcela)}</p></div>
                        <div class="bg-white p-2 rounded-md"><p class="text-xs text-gray-500">Lucro (Empresa)</p><p class="font-bold text-emerald-600">${formatCurrency(lucroLiquidoFinal)}</p></div>
                    </div>
                    <p class="text-xs text-center text-emerald-600 mt-2">Seu lucro e margem originais são mantidos!</p>
                `;
            }
        }

        // --- Funções do Gerador de Abordagem ---
        function gerarPlanoAcao() {
            const nomeCliente = document.getElementById('abordagemNomeCliente').value || "[Nome do Cliente]";
            const nomeEmpresa = document.getElementById('abordagemNomeEmpresa').value || "[Empresa do Cliente]";
            const produto = document.getElementById('abordagemProduto').value || "[Seu Produto/Serviço]";
            const dor = document.getElementById('abordagemDor').value || "[principal dor do cliente]";
            const perfil = document.getElementById('abordagemPerfil').value;

            let plano, script;

            switch (perfil) {
                case 'lobo':
                    plano = `<li><strong>Preparação:</strong> Tenha todos os dados, estudos de caso e a calculadora de ROI/TCO à mão.</li>
                             <li><strong>Abordagem:</strong> Seja direto, objetivo e foque nos números. Evite conversas pessoais longas.</li>
                             <li><strong>Apresentação:</strong> Mostre a lógica por trás da sua solução. Use gráficos e dados concretos.</li>
                             <li><strong>Fechamento:</strong> Apresente a proposta e dê-lhe tempo para analisar. Não pressione. Marque um follow-up com data e hora definidas.</li>`;
                    script = `Olá, ${nomeCliente}. Vi que a ${nomeEmpresa} busca por ${dor}. O nosso ${produto} resolve isso através de [Mecanismo Lógico]. Dados de clientes similares mostram um aumento de X% na eficiência. Gostaria de lhe apresentar os números numa breve chamada de 15 minutos.`;
                    break;
                case 'gato':
                    plano = `<li><strong>Preparação:</strong> Pesquise sobre o cliente (LinkedIn) para encontrar pontos em comum. Tenha depoimentos de clientes satisfeitos prontos.</li>
                             <li><strong>Abordagem:</strong> Comece com uma conversa leve, crie rapport. Mostre interesse genuíno nele.</li>
                             <li><strong>Apresentação:</strong> Conte histórias de sucesso de outros clientes. Foque na segurança, na parceria e no suporte que você oferece.</li>
                             <li><strong>Fechamento:</strong> Ofereça garantias e reforce que você estará ao lado dele durante todo o processo. A decisão é baseada na confiança.</li>`;
                    script = `Olá, ${nomeCliente}! Vi que você também se interessa por [Ponto em Comum]. Muitos dos meus clientes na ${nomeEmpresa} tinham um desafio com ${dor}. Ajudámo-los com o nosso ${produto} e o resultado foi fantástico. Acredito que podemos fazer o mesmo por si. Que tal conversarmos um pouco?`;
                    break;
                case 'tubarao':
                    plano = `<li><strong>Preparação:</strong> Seja rápido. Tenha sua melhor oferta e os resultados chave na ponta da língua.</li>
                             <li><strong>Abordagem:</strong> Vá direto ao ponto. Mostre o que você tem e o que isso fará por ele.</li>
                             <li><strong>Apresentação:</strong> Foque nos resultados, no ROI, na economia. Use a calculadora para mostrar o ganho financeiro.</li>
                             <li><strong>Fechamento:</strong> Apresente duas ou três opções para que ele sinta que está no controlo da decisão. Use frases de ação.</li>`;
                    script = `Olá, ${nomeCliente}. Sei que seu tempo é valioso. O ponto é: você quer resolver ${dor}. O meu ${produto} entrega [Resultado Chave] em X dias. Tenho duas opções para começarmos. Qual prefere?`;
                    break;
                case 'aguia':
                    plano = `<li><strong>Preparação:</strong> Pense fora da caixa. Prepare uma visão de futuro, mostrando como sua solução é inovadora.</li>
                             <li><strong>Abordagem:</strong> Elogie a visão e as ideias do cliente. Pergunte sobre os seus planos para o futuro da empresa.</li>
                             <li><strong>Apresentação:</strong> Use recursos visuais, mostre o "quadro geral". Fale sobre tendências e como sua solução posiciona a empresa dele à frente da concorrência.</li>
                             <li><strong>Fechamento:</strong> Venda o conceito, a visão de futuro. Os detalhes técnicos são secundários. Inspire-o a dar o próximo passo rumo à inovação.</li>`;
                    script = `Olá, ${nomeCliente}. Tenho acompanhado a ${nomeEmpresa} e admiro a vossa visão inovadora. Imagine se vocês pudessem não apenas resolver ${dor}, mas também se tornarem uma referência em [Área de Inovação]. O nosso ${produto} é o primeiro passo para essa visão. Gostaria de partilhar algumas ideias consigo.`;
                    break;
            }

            const resultadoDiv = document.getElementById('resultadoPlanoAcao');
            resultadoDiv.innerHTML = `
                <h3 class="font-bold text-lg mb-2 text-blue-800">Plano de Ação para o Perfil ${perfil.charAt(0).toUpperCase() + perfil.slice(1)}</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-700">${plano}</ul>
                <h3 class="font-bold text-lg mt-4 mb-2 text-blue-800">Sugestão de Script de Abordagem</h3>
                <p class="bg-gray-100 p-3 rounded-md border text-gray-800 italic">"${script}"</p>`;
            resultadoDiv.classList.remove('hidden');
        }

        // --- Funções do Funil Kanban ---
        function addCard() {
            const input = document.getElementById('newCardInput');
            const title = input.value.trim();
            if (!title) return;

            window.cardIdCounter++;
            const newCard = document.createElement('div');
            const newCardId = `card-${window.cardIdCounter}`;
            newCard.id = newCardId;
            newCard.className = 'kanban-card';
            newCard.draggable = true;
            const now = new Date().toISOString();
            newCard.dataset.createdAt = now;
            newCard.dataset.stageHistory = JSON.stringify([{ stage: 'prospect', movedAt: now }]);

            newCard.innerHTML = `
                <button onclick="window.deleteCard('${newCardId}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-50 z-10"><i class="ph ph-trash"></i></button>
                <input type="text" class="card-title-input font-semibold w-full bg-transparent" value="${title}" onblur="window.saveKanbanState()">
                <div class="mt-2 space-y-2 text-sm">
                    <div class="flex items-center gap-2"><i class="ph ph-buildings text-gray-500"></i><input type="text" class="card-company-input card-details-input" placeholder="Empresa" onblur="window.saveKanbanState()"></div>
                    <div class="flex items-center gap-2"><i class="ph ph-user text-gray-500"></i><input type="text" class="card-contact-input card-details-input" placeholder="Contato" onblur="window.saveKanbanState()"></div>
                    <div class="flex items-center gap-2"><i class="ph ph-calendar text-gray-500"></i><input type="text" class="card-date-input card-details-input" placeholder="Data (dd/mm/aa)" onblur="window.saveKanbanState()"></div>
                    <div class="flex items-start gap-2"><i class="ph ph-note-pencil text-gray-500 mt-1"></i><textarea class="card-notes-input card-details-input h-16" placeholder="Anotações..." onblur="window.saveKanbanState()"></textarea></div>
                </div>
                <div class="mt-3 pt-3 border-t">
                    <label class="text-xs font-medium text-gray-500">Valor do Negócio</label>
                    <input type="text" class="card-value-input" value="R$ 0,00" oninput="window.formatInputCurrency(this); window.updateIndicators();" onblur="window.saveKanbanState()">
                </div>
                <div class="mt-2 text-xs text-gray-400 flex justify-between">
                     <span class="card-created-date">Criado agora</span>
                     <span class="card-stage-time">Nesta fase agora</span>
                </div>
            `;
            addCardEventListeners(newCard);
            document.querySelector('.kanban-column[data-column="prospect"] .kanban-cards').appendChild(newCard);
            input.value = '';
            updateIndicators();
            saveKanbanState();
        }

        async function deleteCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const stage = card.parentElement.parentElement.dataset.column;

            if (stage === 'won') {
                await removeWonDeal(cardId);
            }

            card.remove();
            updateIndicators();
            await saveKanbanState();
        }

        function addCardEventListeners(card) {
            card.addEventListener('dragstart', () => {
                draggedCard = card;
                setTimeout(() => card.classList.add('dragging'), 0);
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                draggedCard = null;
            });
        }

        function updateIndicators() {
            const stageProbabilities = {
                prospect: 0.1, qualify: 0.25, proposal: 0.5, negotiate: 0.75, won: 1, lost: 0
            };
            let totalWon = 0, totalLost = 0, activeValue = 0, weightedValue = 0;
            let wonCount = 0, lostCount = 0, activeCount = 0;
            const columns = document.querySelectorAll('.kanban-column');

            columns.forEach(column => {
                const columnId = column.dataset.column;
                const cards = column.querySelectorAll('.kanban-card');
                let columnValue = 0;
                cards.forEach(card => {
                    const value = parseCurrency(card.querySelector('.card-value-input').value);
                    columnValue += value;
                });
                
                const indicatorEl = document.getElementById(`indicators-${columnId}`);
                if (indicatorEl) {
                    indicatorEl.innerHTML = `<span class="font-bold">${formatCurrency(columnValue)}</span> | <span class="text-gray-500">${cards.length} neg.</span>`;
                }

                if (columnId === 'won') {
                    totalWon = columnValue;
                    wonCount = cards.length;
                } else if (columnId === 'lost') {
                    totalLost = columnValue;
                    lostCount = cards.length;
                } else {
                    activeValue += columnValue;
                    activeCount += cards.length;
                    weightedValue += columnValue * (stageProbabilities[columnId] || 0);
                }
            });

            const totalDeals = wonCount + lostCount + activeCount;
            const conversionRate = (wonCount + activeCount) > 0 ? (wonCount / (wonCount + activeCount)) * 100 : 0;
            const averageTicket = wonCount > 0 ? totalWon / wonCount : 0;

            document.getElementById('active-value').textContent = formatCurrency(activeValue);
            document.getElementById('weighted-value').textContent = formatCurrency(weightedValue);
            document.getElementById('won-value').textContent = formatCurrency(totalWon);
            document.getElementById('lost-value').textContent = formatCurrency(totalLost);
            document.getElementById('average-ticket').textContent = formatCurrency(averageTicket);
            document.getElementById('conversion-rate').textContent = `${conversionRate.toFixed(1)}%`;

            const metaValue = parseCurrency(document.getElementById('metaInput').value);
            if (metaValue > 0) {
                const percentage = Math.min((totalWon / metaValue) * 100, 100);
                document.getElementById('goalProgressBar').style.width = `${percentage}%`;
                document.getElementById('goalPercentage').textContent = `${percentage.toFixed(0)}%`;
                const remaining = metaValue - totalWon;
                document.getElementById('goalRemaining').textContent = remaining > 0 ? `Faltam ${formatCurrency(remaining)}` : 'Meta atingida!';
            } else {
                document.getElementById('goalProgressBar').style.width = `0%`;
                document.getElementById('goalPercentage').textContent = `0%`;
                document.getElementById('goalRemaining').textContent = 'Defina uma meta para acompanhar.';
            }
        }

        // --- Funções do Plano de Ação (Tarefas) ---
        function addTask() {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            if (!text) return;

            const taskId = `task-${Date.now()}`;
            const taskEl = document.createElement('div');
            taskEl.id = taskId;
            taskEl.className = 'task-item flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
            taskEl.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" onclick="window.toggleTaskCompletion('${taskId}')">
                    <span class="flex-grow">${text}</span>
                </div>
                <button onclick="window.deleteTask('${taskId}')" class="text-gray-400 hover:text-red-600"><i class="ph-bold ph-trash"></i></button>
            `;

            document.getElementById('taskListContainer').appendChild(taskEl);
            input.value = '';
            saveTasksState();
        }

        function deleteTask(taskId) {
            document.getElementById(taskId)?.remove();
            saveTasksState();
        }

        function toggleTaskCompletion(taskId) {
            document.getElementById(taskId)?.classList.toggle('completed');
            saveTasksState();
        }

        // --- Funções da Aba Vendas da Equipe ---
        function debounceSaveTeamGoal() {
            clearTimeout(saveTeamGoalTimeout);
            saveTeamGoalTimeout = setTimeout(saveTeamGoalState, 1500);
        }

        async function saveTeamGoalState() {
            if (!userId) return;
            updateStatus('Salvando meta da equipe...', 'text-yellow-600');
            const metaValue = parseCurrency(document.getElementById('teamMetaInput').value);
            const teamGoalDocRef = doc(db, `artifacts/${appId}/public/data/settings`, 'teamGoal');
            try {
                await setDoc(teamGoalDocRef, { value: metaValue });
                updateStatus('Salvo', 'text-green-600', false);
            } catch (error) {
                console.error("Erro ao salvar meta da equipe:", error);
                updateStatus('Erro ao salvar', 'text-red-600', false);
            }
        }

        function loadTeamGoalState(data) {
            const teamGoalInput = document.getElementById('teamMetaInput');
            if (data && typeof data.value !== 'undefined') {
                teamGoalInput.value = formatCurrency(data.value);
            }
            // A atualização da barra de progresso será acionada por loadWonDeals
        }
        
        function updateTeamGoalProgress(totalWon, teamGoal) {
            const goalValue = teamGoal || 0;
            const progressBar = document.getElementById('teamGoalProgressBar');
            const percentageText = document.getElementById('teamGoalPercentage');
            const remainingText = document.getElementById('teamGoalRemaining');

            if (goalValue > 0) {
                const percentage = Math.min((totalWon / goalValue) * 100, 100);
                progressBar.style.width = `${percentage}%`;
                percentageText.textContent = `${percentage.toFixed(0)}%`;
                const remaining = goalValue - totalWon;
                remainingText.textContent = remaining > 0 ? `Faltam ${formatCurrency(remaining)}` : 'Meta da equipe atingida!';
            } else {
                progressBar.style.width = '0%';
                percentageText.textContent = '0%';
                remainingText.textContent = 'Defina uma meta para a equipe.';
            }
        }

        function loadWonDeals(deals) {
            const listBody = document.getElementById('wonDealsList');
            listBody.innerHTML = '';
            let totalWonValue = 0;

            if (deals.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">Nenhuma venda ganha ainda.</td></tr>';
            } else {
                deals.forEach(deal => {
                    const row = document.createElement('tr');
                    const dealDate = deal.wonAt?.toDate ? deal.wonAt.toDate() : new Date();
                    const sellerName = (deal.sellerEmail && typeof deal.sellerEmail === 'string') ? deal.sellerEmail.split('@')[0] : 'Desconhecido';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${deal.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-semibold">${formatCurrency(deal.value)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sellerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dealDate.toLocaleDateString('pt-BR')}</td>
                    `;
                    listBody.appendChild(row);
                    totalWonValue += deal.value;
                });
            }
            const teamGoal = parseCurrency(document.getElementById('teamMetaInput').value);
            updateTeamGoalProgress(totalWonValue, teamGoal);
        }

        async function addWonDeal(card) {
             if (!userId || !auth.currentUser) return;
            const dealData = {
                cardId: card.id,
                title: card.querySelector('.card-title-input').value,
                value: parseCurrency(card.querySelector('.card-value-input').value),
                sellerId: userId,
                sellerEmail: auth.currentUser.email || `anon-${userId.substring(0,6)}`,
                wonAt: serverTimestamp()
            };
            try {
                const wonDealsCol = collection(db, `artifacts/${appId}/public/data/wonDeals`);
                const q = query(wonDealsCol, where("cardId", "==", card.id));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    await addDoc(wonDealsCol, dealData);
                }
            } catch (error) {
                console.error("Erro ao adicionar venda ganha:", error);
            }
        }

        async function removeWonDeal(cardId) {
            if (!userId) return;
            try {
                const wonDealsCol = collection(db, `artifacts/${appId}/public/data/wonDeals`);
                // Query mais segura: só busca por vendas ganhas que pertencem ao usuário atual
                const q = query(wonDealsCol, where("cardId", "==", cardId), where("sellerId", "==", userId));
                const querySnapshot = await getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);

            } catch (error) {
                console.error("Erro ao remover venda ganha. Verifique as regras de segurança do Firestore.", error);
            }
        }


        // --- Inicialização da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            
            window.changeTab = changeTab;
            window.changeCalcMode = changeCalcMode;
            window.changeSubCalcMode = changeSubCalcMode;
            window.analiseFinanceira = analiseFinanceira;
            window.recalcularSinal = recalcularSinal;
            window.usarUltimoPreco = usarUltimoPreco;
            window.calcularRoi = calcularRoi;
            window.calcularTco = calcularTco;
            window.simularDesconto = simularDesconto;
            window.calcularDescontoMaximo = calcularDescontoMaximo;
            window.calcularParcelamento = calcularParcelamento;
            window.gerarPlanoAcao = gerarPlanoAcao;
            window.addCard = addCard;
            window.deleteCard = deleteCard;
            window.saveKanbanState = saveKanbanState;
            window.updateIndicators = updateIndicators;
            window.debounceSaveNotes = debounceSaveNotes;
            window.debounceSaveGoal = debounceSaveGoal;
            window.debounceSaveTeamGoal = debounceSaveTeamGoal;
            window.adicionarItemKit = adicionarItemKit;
            window.atualizarCustoTotalKit = atualizarCustoTotalKit;
            window.addTask = addTask;
            window.deleteTask = deleteTask;
            window.toggleTaskCompletion = toggleTaskCompletion;
            window.formatInputCurrency = formatInputCurrency;

             // Lógica de autenticação
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('registerButton').addEventListener('click', handleRegister);
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            document.getElementById('showRegister').addEventListener('click', toggleAuthForms);
            document.getElementById('showLogin').addEventListener('click', toggleAuthForms);

            // Lógica Kanban Drag & Drop
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    const cardsContainer = column.querySelector('.kanban-cards');
                    cardsContainer.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => {
                     const cardsContainer = column.querySelector('.kanban-cards');
                     cardsContainer.classList.remove('drag-over');
                });
                column.addEventListener('drop', async () => {
                    const cardsContainer = column.querySelector('.kanban-cards');
                    cardsContainer.classList.remove('drag-over');
                    if (draggedCard) {
                        const originalStage = draggedCard.parentElement.parentElement.dataset.column;
                        cardsContainer.appendChild(draggedCard);
                        
                        const newStage = column.dataset.column;
                        let stageHistory = JSON.parse(draggedCard.dataset.stageHistory || '[]');
                        stageHistory.push({ stage: newStage, movedAt: new Date().toISOString() });
                        draggedCard.dataset.stageHistory = JSON.stringify(stageHistory);
                        
                        // Se o card foi movido PARA "Ganho"
                        if (newStage === 'won' && originalStage !== 'won') {
                            await addWonDeal(draggedCard);
                        }
                        
                        // Se o card foi movido DE "Ganho"
                        if (originalStage === 'won' && newStage !== 'won') {
                           await removeWonDeal(draggedCard.id);
                        }

                        updateIndicators();
                        saveKanbanState();
                    }
                });
            });

            const kanbanBoard = document.querySelector('.kanban-board');
            kanbanBoard.addEventListener('dragover', (e) => {
                if (!draggedCard) return;

                const x = e.clientX;
                const scrollSpeed = 15;
                const hotZone = 100;

                const boardRect = kanbanBoard.getBoundingClientRect();

                if (e.clientY >= boardRect.top && e.clientY <= boardRect.bottom) {
                    if (x > window.innerWidth - hotZone) {
                        kanbanBoard.scrollLeft += scrollSpeed;
                    } else if (x < hotZone) {
                        kanbanBoard.scrollLeft -= scrollSpeed;
                    }
                }
            });


             // Lógica Simulador Parcelamento
            document.getElementById('quemPagaTaxaContainer').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('.quem-paga-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });

            // Define o listener de autenticação
            onAuthStateChanged(auth, user => {
                const authOverlay = document.getElementById('authOverlay');
                const appContent = document.getElementById('appContent');
                const userSection = document.getElementById('userSection');

                // Limpa todos os listeners para evitar duplicação
                kanbanUnsubscribe();
                notesUnsubscribe();
                goalUnsubscribe();
                taskUnsubscribe();
                teamGoalUnsubscribe();
                wonDealsUnsubscribe();

                if (user) {
                    userId = user.uid;
                    authOverlay.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    userSection.classList.remove('hidden');
                    document.getElementById('userEmailDisplay').textContent = user.email || `Vendedor ${user.uid.substring(0,6)}`;

                    // Listeners de dados do usuário (privados)
                    const kanbanDocRef = doc(db, `artifacts/${appId}/users/${userId}/kanban`, 'boardState');
                    kanbanUnsubscribe = onSnapshot(kanbanDocRef, (doc) => loadKanbanState(doc.data()));

                    const notesDocRef = doc(db, `artifacts/${appId}/users/${userId}/notes`, 'allNotes');
                    notesUnsubscribe = onSnapshot(notesDocRef, (doc) => loadNotesState(doc.data()));
                    
                    const goalDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'goal');
                    goalUnsubscribe = onSnapshot(goalDocRef, (doc) => loadGoalState(doc.data()));
                    
                    const tasksDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, 'taskList');
                    taskUnsubscribe = onSnapshot(tasksDocRef, (doc) => loadTasksState(doc.data()));

                    // Listeners de dados públicos/da equipe
                    const teamGoalDocRef = doc(db, `artifacts/${appId}/public/data/settings`, 'teamGoal');
                    teamGoalUnsubscribe = onSnapshot(teamGoalDocRef, (doc) => loadTeamGoalState(doc.data()));

                    const wonDealsCol = collection(db, `artifacts/${appId}/public/data/wonDeals`);
                    const q = query(wonDealsCol, orderBy('wonAt', 'desc'), limit(50));
                    wonDealsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                        const deals = [];
                        querySnapshot.forEach((doc) => {
                            deals.push(doc.data());
                        });
                        loadWonDeals(deals);
                    }, (error) => {
                        console.error("Erro ao carregar vendas ganhas:", error);
                        document.getElementById('wonDealsList').innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-500">Erro ao carregar dados. Verifique as permissões do Firestore.</td></tr>';
                    });

                } else {
                    userId = null;
                    authOverlay.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    userSection.classList.add('hidden');
                    resetUIState();
                }
            });
        });
    </script>
</body>
</html>

